var N=Object.defineProperty;var ee=Object.getOwnPropertyDescriptor;var te=Object.getOwnPropertyNames;var re=Object.prototype.hasOwnProperty;var ae=(t,e)=>()=>(t&&(e=t(t=0)),e);var O=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var E=(t,e,r,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of te(e))!re.call(t,o)&&o!==r&&N(t,o,{get:()=>e[o],enumerable:!(i=ee(e,o))||i.enumerable});return t},M=(t,e,r)=>(E(t,e,"default"),r&&E(r,e,"default"));var z=t=>E(N({},"__esModule",{value:!0}),t);var v={};import*as we from"https://registry.koishi.chat/modules/koishi/index.js";var I=ae(()=>{M(v,we)});var B=O(f=>{"use strict";Object.defineProperty(f,"__esModule",{value:!0});f.parseInput=f.parseForbidden=f.Config=f.PromptConfig=void 0;var s=(I(),z(v)),ne=["nsfw, lowres, bad anatomy, bad hands, text, error, missing fingers","extra digit, fewer digits, cropped, worst quality, low quality","normal quality, jpeg artifacts, signature, watermark, username, blurry"].join(", ");f.PromptConfig=s.Schema.object({basePrompt:s.Schema.string().role("textarea").description("默认附加的标签。").default("masterpiece, best quality"),negativePrompt:s.Schema.string().role("textarea").description("默认附加的反向标签。").default(ne),forbidden:s.Schema.string().role("textarea").description("违禁词列表。请求中的违禁词将会被自动删除。").default(""),placement:s.Schema.union([s.Schema.const("before").description("置于最前"),s.Schema.const("after").description("置于最后")]).description("默认附加标签的位置。").default("after"),translator:s.Schema.boolean().description("是否启用自动翻译。").default(!1),latinOnly:s.Schema.boolean().description("是否只接受英文输入。").default(!0)}).description("输入设置");f.Config=s.Schema.intersect([s.Schema.object({weigh:s.Schema.number().description("默认宽度比").default(1),hight:s.Schema.number().description("默认高度比").default(1.3),strength:s.Schema.number().description("默认图转图强度").default(.6),scale:s.Schema.number().description("默认提示词相关度").default(11),censor:s.Schema.boolean().description("是否启用图像审核。").default(!1)}),f.PromptConfig,s.Schema.object({output:s.Schema.union([s.Schema.const("minimal").description("仅图片"),s.Schema.const("default").description("标准输出"),s.Schema.const("verbose").description("详细输出")]).description("输出方式。").default("default"),requestTimeout:s.Schema.number().role("time").description("当请求超过这个时间时会中止并提示超时。").default(s.Time.minute),recallTimeout:s.Schema.number().role("time").description("图片发送后自动撤回的时间 (设置为 0 以禁用此功能)。").default(0),maxConcurrency:s.Schema.number().description("单个频道下的最大并发数量 (设置为 0 以禁用此功能)。").default(0)}).description("高级设置")]);function ie(t){return t.trim().toLowerCase().replace(/，/g,",").split(/(?:,\s*|\s*\n\s*)/g).filter(Boolean).map(e=>{let r=e.endsWith("!");return r&&(e=e.slice(0,-1)),e=e.replace(/[^a-z0-9]+/g," ").trim(),{pattern:e,strict:r}})}f.parseForbidden=ie;var D=/@@__BACKSLASH__@@/g;function oe(t,e,r,i){if(t=t.toLowerCase().replace(/\\\\/g,D.source).replace(/，/g,",").replace(/（/g,"(").replace(/）/g,")"),t=t.split("\\{").map(n=>n.replace(/\{/g,"(")).join("\\{").split("\\}").map(n=>n.replace(/\}/g,")")).join("\\}"),t=t.replace(D,"\\").replace(/_/g," "),e.latinOnly&&/[^\s\w"'“”‘’.,:|\\()\[\]{}-]/.test(t))return{errPath:".latin-only"};let o=[],h=(n,l)=>{let w=l.split(/,\s*/g);e.placement==="before"&&w.reverse();for(let m of w)m=m.trim().toLowerCase(),!(!m||n.includes(m))&&(e.placement==="before"?n.unshift(m):n.push(m))},b=t.match(/(,\s*|\s+)(-u\s+|--undesired\s+|negative prompts?:\s*)([\s\S]+)/m);b?.[3]&&(t=t.slice(0,b.index).trim(),h(o,b[3]));let a=t.split(/,\s*/g).filter(n=>{if(n=n.replace(/[\x00-\x7f]/g,l=>l.replace(/[^0-9a-zA-Z]/," ")).replace(/\s+/," ").trim(),!n)return!1;for(let{pattern:l,strict:w}of r){if(w&&n.split(/\W+/g).includes(l))return!1;if(!w&&n.includes(l))return!1}return!0});return i||(h(a,e.basePrompt),h(o,e.negativePrompt)),{errPath:null,positive:a,uc:o.join(", ")}}f.parseInput=oe});var F=O(()=>{});var Z=O(p=>{"use strict";var se=p&&p.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(p,"__esModule",{value:!0});p.NetworkError=p.download=p.arrayBufferToBase64=p.getImageSize=void 0;var H=(I(),z(v)),ve=se(F());function ce(t){{let e=new Blob([t]),r=new Image;return r.src=URL.createObjectURL(e),(0,H.pick)(r,["width","height"])}}p.getImageSize=ce;function K(t){{let e="";for(let i=0;i<t.byteLength;i+=8192)e+=String.fromCharCode.apply(null,t.slice(i,i+8192));return btoa(e)}}p.arrayBufferToBase64=K;var ue=10485760,W=["image/jpeg","image/png","image/webp"];async function le(t,e,r={}){if(e.startsWith("data:")){let[,i,o]=e.match(/^data:(image\/\w+);base64,(.*)$/);if(!W.includes(i))throw new S(".unsupported-file-type");let h=atob(o),b=new Uint8Array(h.length);for(let a=0;a<h.length;a++)b[a]=h.charCodeAt(a);return{buffer:b,base64:o,dataUrl:e}}else{let i=await t.http.head(e,{headers:r});if(+i["content-length"]>ue)throw new S(".file-too-large");let o=i["content-type"];if(!W.includes(o))throw new S(".unsupported-file-type");let h=await t.http.get(e,{responseType:"arraybuffer",headers:r}),b=K(h);return{buffer:h,base64:b,dataUrl:`data:${o};base64,${b}`}}}p.download=le;var S=class extends Error{constructor(e,r={}){super(e),this.params=r}};p.NetworkError=S;S.catch=t=>e=>{if(H.Quester.isAxiosError(e)){let r=e.response?.status;for(let i in t)if(r===+i)throw new S(t[i])}throw e}});var Q=O((je,de)=>{de.exports={commands:{rryth:{description:"人人有图画计划 2.4.3",usage:`输入 sai 空格提示词即可画画，提示词是用逗号分隔的英文
示例 sai -r 512x768 -t 28 -c 7 tree, yellow -u green
本插件基于 novelai-bot 修改完成，旨在提供免费画画方案
好用的话去点个 star https://github.com/MirrorCY/rryth`,options:{resolution:"设定图片比例(1.5x1.2)",seed:"设置随机种子(随意一个数字)",scale:"提示词相关性(0-20)",strength:"图片修改强度(0-1)",undesired:"反向提示词(加在提示词后)",override:"去除插件附加的提示词"},messages:{"expect-prompt":"请输入标签。","expect-image":"请输入图片。","latin-only":"只接受英文输入。","concurrent-jobs":`<random>
  <>等会再约稿吧，我已经忙不过来了……</>
  <>是数位板没电了，才…才不是我不想画呢！</>
  <>那你得先教我画画（理直气壮</>
</random>`,waiting:`<random>
  <>少女绘画中……</>
  <>在画了在画了</>
  <>你就在此地不要走动，等我给你画一幅</>
</random>`,pending:"在画了在画了，不过前面还有 {0} 个稿……","file-too-large":"文件体积过大。","unsupported-file-type":"不支持的文件格式。","download-error":"图片解析失败。","unknown-error":"发生未知错误。","response-error":"发生未知错误 ({0})。","empty-response":"服务器返回了空白图片，请稍后重试。","request-failed":"请求失败 ({0})，请稍后重试。","request-timeout":"请求超时。"}}}}});var ge=O(u=>{var he=u&&u.__createBinding||(Object.create?function(t,e,r,i){i===void 0&&(i=r);var o=Object.getOwnPropertyDescriptor(e,r);(!o||("get"in o?!e.__esModule:o.writable||o.configurable))&&(o={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,i,o)}:function(t,e,r,i){i===void 0&&(i=r),t[i]=e[r]}),pe=u&&u.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&he(e,t,r)};Object.defineProperty(u,"__esModule",{value:!0});u.apply=u.name=u.reactive=void 0;var g=(I(),z(v)),R=B(),L=Z();pe(B(),u);u.reactive=!0;u.name="rryth";var q=new g.Logger(u.name);function me(t,e){if(g.Quester.isAxiosError(e)){if(e.response?.data)return q.error(e.response.data),t.text(e.response.data.message);if(e.response?.status===402)return t.text(".unauthorized");if(e.response?.status)return t.text(".response-error",[e.response.status]);if(e.code==="ETIMEDOUT")return t.text(".request-timeout");if(e.code)return t.text(".request-failed",[e.code])}return q.error(e),t.text(".unknown-error")}function fe(t,e){t.i18n.define("zh",Q());let r,i=Object.create(null),o=new Set;t.accept(["forbidden"],a=>{r=(0,R.parseForbidden)(a.forbidden)},{immediate:!0});let h=a=>{let n=a.match(/^(\d*\.?\d+)[x×](\d*\.?\d+)$/);if(!n)throw new Error;let l=+n[1],w=+n[2];return{width:l,height:w}},b=t.command(`${u.name} <prompts:text>`).alias("sai","rr").userFields(["authority"]).option("resolution","-r <resolution>",{type:h}).option("override","-O").option("seed","-x <seed:number>").option("scale","-c <scale:number>").option("strength","-N <strength:number>").option("undesired","-u <undesired>").action(async({session:a,options:n},l)=>{var w;if(!l?.trim())return a.execute(`help ${u.name}`);let m,P;if(l=g.h.transform(l,{image(c){return m=c.url,""}}),!l.trim()&&!e.basePrompt)return a.text(".expect-prompt");let{errPath:k,positive:V,uc:A}=(0,R.parseInput)(l,e,r,n.override),j=V.join(", ");if(k)return a.text(k);if(e.translator&&t.translator){let c=j.match(/[\u4e00-\u9fa5]+/g);if(c?.length>0)try{let y=(await t.translator.translate({input:c.join(","),target:"en"})).toLocaleLowerCase().split(",");c.forEach((_,x)=>{j=j.replace(_,y[x]).replace("，",",")})}catch(y){q.warn(y)}}let U=n.seed||Math.floor(Math.random()*Math.pow(2,32)),d={seed:U,prompt:j,uc:A,scale:n.scale??e.scale??11,steps:m?50:28};if(m){try{P=await(0,L.download)(t,m)}catch(c){return c instanceof L.NetworkError?a.text(c.message,c.params):(q.error(c),a.text(".download-error"))}n.resolution||(n.resolution=(0,L.getImageSize)(P.buffer)),Object.assign(d,{height:n.resolution.height,width:n.resolution.width,strength:n.strength??e.strength??.3})}else n.resolution||(n.resolution={height:e.hight,width:e.weigh}),Object.assign(d,{height:n.resolution.height,width:n.resolution.width});let T=Math.random().toString(36).slice(2);if(e.maxConcurrency){let c=i[w=a.cid]||(i[w]=new Set);if(c.size>=e.maxConcurrency)return a.text(".concurrent-jobs");c.add(T)}a.send(o.size?a.text(".pending",[o.size]):a.text(".waiting")),o.add(T);let $=()=>{i[a.cid]?.delete(T),o.delete(T)},X=(()=>({init_images:P&&[P.dataUrl],prompt:d.prompt,seed:d.seed,negative_prompt:d.uc,cfg_scale:d.scale,width:d.width,height:d.height,denoising_strength:d.strength,steps:d.steps}))(),Y=()=>t.http.axios("https://rryth.elchapo.cn:11000/v2",{method:"POST",timeout:e.requestTimeout,headers:{api:"42",...e.headers},data:X}).then(c=>c.data.images),C;for(;;)try{C=await Y(),$();break}catch(c){return $(),me(a,c)}async function G(){let c=e.censor?(0,g.h)("censor",(0,g.h)("image",{url:"data:image/png;base64,"+C[0]})):(0,g.h)("image",{url:"data:image/png;base64,"+C[0]}),y={userId:a.userId,nickname:a.author?.nickname||a.username};if(e.output==="minimal")return c;let _=(0,g.h)("figure"),x=[`种子 = ${U}`];return e.output==="verbose"&&(x.push("模型 = Anything 3.0"),x.push(`提示词相关度 = ${d.scale}`),d.image&&x.push(`图转图强度 = ${d.strength}`)),_.children.push((0,g.h)("message",y,x.join(`
`))),_.children.push((0,g.h)("message",y,`关键词 = ${j}`)),e.output==="verbose"&&_.children.push((0,g.h)("message",y,`排除关键词 = ${A}`)),_.children.push(c),e.output==="verbose"&&_.children.push((0,g.h)("message",y,"工作站名称 = 42")),_}let J=await a.send(await G());e.recallTimeout&&t.setTimeout(()=>{for(let c of J)a.bot.deleteMessage(a.channelId,c)},e.recallTimeout)})}u.apply=fe});export default ge();
