import{difference as b,observe as p}from"https://registry.koishi.chat/modules/koishi/index.js";var w=Object.defineProperty,f=(n,u)=>w(n,"name",{value:u,configurable:!0}),_={internal:{"error-encountered":"发生未知错误：{0}"},admin:{"user-option":"指定目标用户","user-not-found":"未找到指定的用户。","user-unchanged":"用户数据未改动。","user-updated":"用户数据已修改。","channel-option":"指定目标频道","channel-not-found":"未找到指定的频道。","channel-unchanged":"频道数据未改动。","channel-updated":"频道数据已修改。","not-in-group":"当前不在群组上下文中，请使用 -c 参数指定目标频道。"}},U={internal:{"error-encountered":"An unknown error has occurred: {0}"},admin:{"user-not-found":"User not found.","user-unchanged":"User data unchanged.","user-updated":"User data updated.","channel-not-found":"Channel not found.","channel-unchanged":"Channel data unchanged.","channel-updated":"Channel data updated.","not-in-group":"Not in guild context, use -c to specify target channel."}},$={internal:{"error-encountered":"不明なエラーが発生しました：{0}"},admin:{"user-option":"特定のユーザーを指定する","user-not-found":"指定されたユーザーが見つかりません。","user-unchanged":"ユーザーデータは変更されていません。","user-updated":"ユーザーデータが変更されました。","channel-option":"特定のチャンネルを指定する","channel-not-found":"指定されたチャンネルが見つかりません。","channel-unchanged":"チャンネルデータは変更されていません。","channel-updated":"チャンネルデータが変更されました。","not-in-group":"ギルドコンテキストではありません。-c を使用して特定のチャンネルを指定します。"}},C={internal:{"error-encountered":"Une erreur inconnue s'est produite : {0}"},admin:{"user-not-found":"Utilisateur introuvable.","user-unchanged":"Les données utilisateur n'ont pas été modifiées.","user-updated":"Les données utilisateur ont été changées.","channel-not-found":"Canel introuvable.","channel-unchanged":"Les données du canel n'ont pas été modifiées.","channel-updated":"Les données du canel ont été changées.","not-in-group":"Vous n'êtes pas dans le contexte du groupe, tapez -c pour spécifier le canel cible."}},j={internal:{"error-encountered":"出現未知錯誤：{0}"},admin:{"user-not-found":"找不到指定的用戶。","user-unchanged":"用戶資料未更新。","user-updated":"用戶資料已更新。","channel-option":"指定目標頻道","channel-not-found":"找不到指定的頻道。","channel-unchanged":"頻道資料未更新。","channel-updated":"頻道資料已更新。","not-in-group":"當前不在群組上下文中，請使用 -c 參數指定目標頻道。"}};function g(n){let u=n.indexOf(":"),c=n.slice(0,u),t=n.slice(u+1);return[c,t]}f(g,"parsePlatform");var x=new WeakSet;function y(n){x.has(n)||(x.add(n),n.i18n.define("zh",_),n.i18n.define("en",U),n.i18n.define("ja",$),n.i18n.define("fr",C),n.i18n.define("zh-TW",j))}f(y,"loadI18n");function P(n,u){return y(n.ctx.root),n.action(async(c,...t)=>{try{return await c.next()}catch(r){return u?u(r,c):c.session.text("internal.error-encountered",[r.message])}},!0)}f(P,"handleError");function k(n){let u=!1;y(n.ctx.root);async function c(t){let{options:r,session:e}=t,{user:i,app:s}=e;if(!r.user)return;let[a,o]=g(r.user);if(e.user[a]===o)return;let l=e.collect("user",t),h=await s.database.getUser(a,o,[...l]);if(h){if(i.authority<=h.authority)return e.text("internal.low-authority");e.user=p(h,async d=>{await s.database.setUser(a,o,d)},`user ${r.user}`)}else{u=!0;let d=s.model.tables.user.create();d[a]=o,e.user=p(d,async m=>{await s.database.createUser(a,o,m)},`user ${r.user}`)}}return f(c,"setTarget"),n.option("user","-u [user:user]",{authority:3,descPath:"admin.user-option"}).userFields(["authority"]).userFields(({session:t,options:r},e)=>{let i=r.user?r.user.split(":")[0]:t.platform;e.add(i)}).action(async(t,...r)=>{let{session:e,next:i}=t,s=e.user,a=await c(t);if(a)return a;try{let o=Object.keys(e.user.$diff),l=await i();if(u&&!e.user.authority)return e.text("admin.user-not-found");if(typeof l=="string")return l;if(b(Object.keys(e.user.$diff),o).length){if(e.user!==s&&e.user.authority>=s.authority)return e.text("internal.low-authority")}else return e.text("admin.user-unchanged");return await e.user.$update(),e.text("admin.user-updated")}finally{e.user=s}},!0)}f(k,"adminUser");function F(n){let u=!1;y(n.ctx.root);async function c(t){let{options:r,session:e}=t,{app:i}=e;if(e.subtype==="private"&&!r.channel)return e.text("admin.not-in-group");let{channel:s=e.cid}=r;if(s===e.cid&&!e.channel.$detached)return;let[a,o]=g(s),l=t.session.collect("channel",t),h=await i.database.getChannel(a,o,[...l]);if(h)e.channel=p(h,async d=>{await i.database.setChannel(a,o,d)},`channel ${s}`);else{u=!0;let d=i.model.tables.channel.create();d.platform=a,d.id=o,e.channel=p(d,async m=>{await i.database.createChannel(a,o,m)},`channel ${s}`)}}return f(c,"setTarget"),n.channelFields(["assignee"]).option("channel","-c [channel:channel]",{authority:3,descPath:"admin.channel-option"}).action(async(t,...r)=>{let{session:e,next:i}=t,s=e.channel,a=await c(t);if(a)return a;try{let o=Object.keys(e.channel.$diff),l=await i();return u&&!e.channel.assignee?e.text("admin.channel-not-found"):typeof l=="string"?l:b(Object.keys(e.channel.$diff),o).length?(await e.channel.$update(),e.text("admin.channel-updated")):e.text("admin.channel-unchanged")}finally{e.channel=s}},!0)}f(F,"adminChannel");export{F as adminChannel,k as adminUser,P as handleError,g as parsePlatform};
