var g=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var C=Object.getOwnPropertyNames;var U=Object.prototype.hasOwnProperty;var m=(s,e)=>()=>(s&&(e=s(s=0)),e);var x=(s,e)=>()=>(e||s((e={exports:{}}).exports,e),e.exports);var p=(s,e,r,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of C(e))!U.call(s,a)&&a!==r&&g(s,a,{get:()=>e[a],enumerable:!(t=M(e,a))||t.enumerable});return s},i=(s,e,r)=>(p(s,e,"default"),r&&p(r,e,"default"));var b=s=>p(g({},"__esModule",{value:!0}),s);var o={};import*as V from"https://registry.koishi.chat/modules/koishi/index.js";var f=m(()=>{i(o,V)});var d={};import*as W from"https://registry.koishi.chat/modules/@koishijs/plugin-console/index.js";var _=m(()=>{i(d,W)});var I=x(()=>{});var G=x((X,j)=>{var u=Object.defineProperty,B=Object.getOwnPropertyDescriptor,E=Object.getOwnPropertyNames,K=Object.prototype.hasOwnProperty,l=(s,e)=>u(s,"name",{value:e,configurable:!0}),A=(s,e)=>{for(var r in e)u(s,r,{get:e[r],enumerable:!0})},H=(s,e,r,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of E(e))!K.call(s,a)&&a!==r&&u(s,a,{get:()=>e[a],enumerable:!(t=B(e,a))||t.enumerable});return s},$=s=>H(u({},"__esModule",{value:!0}),s),w={};A(w,{Config:()=>z,UserProvider:()=>h,apply:()=>k,filter:()=>L,name:()=>N,using:()=>R});j.exports=$(w);var O=(f(),b(o)),q=(_(),b(d)),T=I(),n=(f(),b(o)),v=class extends n.Messenger{constructor(){super(...arguments),this.buffer="",this.rules=Object.fromEntries(["image","audio","video","file"].map(s=>[s,async e=>e.url.startsWith("file:")&&this.bot.ctx.assets?(0,n.h)(s,{...e,url:await this.bot.ctx.assets.upload(e.url,e.url)}):(0,n.h)(s,e)]))}async flush(){if(!this.buffer.trim())return;let s=await n.h.transformAsync(this.buffer.trim(),this.rules),e=this.bot.session(this.session);e.messageId=n.Random.id(),e.app.console.broadcast("sandbox",{content:s,user:"Koishi",channel:e.channelId,id:e.messageId}),this.results.push(e),this.buffer=""}async visit(s){let{type:e,children:r}=s;e==="message"||e==="figure"?(await this.flush(),await this.render(r),await this.flush()):this.buffer+=s.toString()}};l(v,"SandboxMessenger");var P=class extends n.Bot{constructor(s){super(s,{platform:"sandbox",selfId:"koishi"}),this.ctx=s,this.username="koishi",this.hidden=!0,this.internal={};let e=this;s.console.addListener("sandbox/message",async function(r,t,a){let c=n.Random.id();s.console.broadcast("sandbox",{id:c,content:a,user:r,channel:t});let y=e.session({userId:r,content:a,messageId:c,channelId:t,guildId:t==="@"+r?void 0:t,type:"message",subtype:t==="@"+r?"private":"group",author:{userId:r,username:r}});(0,n.defineProperty)(y,"client",this),e.dispatch(y)},{authority:4})}async sendMessage(s,e,r,t){return new v(this,s,r,t).send(e)}async sendPrivateMessage(s,e,r){return new v(this,"@"+s,void 0,r).send(e)}async deleteMessage(s,e){this.ctx.console.broadcast("sandbox/delete",{id:e,channel:s})}async getGuildMemberList(s){return S.map(e=>({nickname:e,userId:e}))}};l(P,"SandboxBot");var S=["Alice","Bob","Carol","Dave","Eve","Frank","Grace","Hank","Ivy","Jack","Kathy","Lily","Mandy","Nancy","Oscar","Peggy","Quinn","Randy","Sandy","Toby","Uma","Vicky","Wendy","Xander","Yvonne","Zoe"],D={commands:{clear:{description:"清空聊天记录"}}},h=class extends q.DataService{constructor(s,e){super(s,"sandbox",{authority:4}),this.config=e,s.console.addListener("sandbox/user",async(r,t)=>{let a=await this.get();if(a[r]){if(!t)return delete a[r],this.ctx.$internal._userCache.set("sandbox","sandbox:"+r,null),this.ctx.database.remove("user",{sandbox:r})}else{if(!t)return;let c=await this.ctx.database.createUser("sandbox",r,{authority:1,...t});return this.observe(c,a)}return Object.assign(a[r],t),a[r].$update()},{authority:4})}observe(s,e){let r="sandbox:"+s.sandbox;e[s.sandbox]=(0,O.observe)(s,async t=>{await this.ctx.database.setUser("sandbox",s.sandbox,t),this.refresh()}),this.ctx.$internal._userCache.set("sandbox",r,e[s.sandbox])}async prepare(){let s=await this.ctx.database.getUser("sandbox",S),e={};for(let r of s)this.observe(r,e);return e}stop(){this.ctx.$internal._userCache.delete("sandbox")}async get(){return this.task||(this.task=this.prepare())}};l(h,"UserProvider");h.using=["database"];var L=!1,N="sandbox",R=["console"],z=O.Schema.object({});function k(s,e){s.plugin(P),s.plugin(h),s.console.addEntry(["https://registry.koishi.chat/modules/@koishijs/plugin-sandbox/dist/index.js","https://registry.koishi.chat/modules/@koishijs/plugin-sandbox/dist/style.css"]),s.i18n.define("zh",D),s.platform("sandbox").command("clear").action(({session:r})=>{r.client.send({type:"sandbox/clear"})})}l(k,"apply")});export default G();
