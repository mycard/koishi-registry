import{Schema as Q}from"https://registry.koishi.chat/modules/koishi/index.js";import{DataService as U}from"https://registry.koishi.chat/modules/@koishijs/plugin-console/index.js";import{Logger as F,Time as G}from"https://registry.koishi.chat/modules/koishi/index.js";import{DataService as H}from"https://registry.koishi.chat/modules/@koishijs/plugin-console/index.js";import{DataService as N}from"https://registry.koishi.chat/modules/@koishijs/plugin-console/index.js";function D(e,r,s,t){var o,i=!1,n=0;function a(){o&&clearTimeout(o)}function l(){a(),i=!0}typeof r!="boolean"&&(t=s,s=r,r=void 0);function p(){for(var b=arguments.length,_=new Array(b),u=0;u<b;u++)_[u]=arguments[u];var B=this,S=Date.now()-n;if(i)return;function g(){n=Date.now(),s.apply(B,_)}function L(){o=void 0}t&&!o&&g(),a(),t===void 0&&S>e?g():r!==!0&&(o=setTimeout(t?L:g,t===void 0?e-S:e))}return p.cancel=l,p}function C(e,r,s){return s===void 0?D(e,r,!1):D(e,s,r!==!1)}import{DataService as T}from"https://registry.koishi.chat/modules/@koishijs/plugin-console/index.js";import{Context as O}from"https://registry.koishi.chat/modules/koishi/index.js";import{DataService as q}from"https://registry.koishi.chat/modules/@koishijs/plugin-console/index.js";import{remove as z}from"https://registry.koishi.chat/modules/koishi/index.js";import{Loader as f}from"https://registry.koishi.chat/modules/@koishijs/loader/index.js";var j=Object.defineProperty,M=(e,r,s)=>r in e?j(e,r,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[r]=s,c=(e,r)=>j(e,"name",{value:r,configurable:!0}),W=(e,r,s)=>(M(e,typeof r!="symbol"?r+"":r,s),s),$=new F("market"),v=class extends H{_task;_timestamp=0;_error;constructor(e){super(e,"market",{authority:4}),e.console.addListener("market/refresh",()=>this.start(),{authority:4}),e.on("console/connection",async r=>{e.console.clients[r.id]&&(Date.now()-this._timestamp<=G.hour*12||await this.ctx.serial("console/intercept",r,{authority:4})||this.start())})}start(){this._task=null,this._timestamp=Date.now()}async prepare(){return this._task||=this.collect().catch(e=>{$.warn(e),this._error=e})}};c(v,"MarketProvider");var k=class extends N{constructor(e){super(e,"packages",{authority:4});let r=C(0,this.update.bind(this));e.on("internal/runtime",r),e.on("internal/fork",r)}update(e){this.refresh()}parseRuntime(e,r){r.id=e.uid,r.forkable=e.isForkable}};c(k,"PackageProvider");var y=class extends T{constructor(e){super(e,"services"),e.on("internal/service",()=>this.refresh())}async get(){let e={},r=Object.getOwnPropertyDescriptors(O.prototype);for(let s in r){if("value"in r[s])continue;let o=this.ctx[s]?.[O.source]?.state.uid;o&&(e[s]=o)}return e}};c(y,"ServiceProvider");function I(e){return e.split(/\/?(@[\w-]+\/[\w:-]+|[\w:-]+)\/?/).filter(Boolean)}c(I,"splitPath");function P(e,r,s){for(let t of s)r[t]=e[t],delete e[t];Object.assign(e,r)}c(P,"insertKey");function d(e,r,s,t){let o=Object.keys(e),i=o.findIndex(l=>l===r||l==="~"+r),n=i<0?[]:o.slice(i+1),a={[s]:t};delete e[r],delete e["~"+r],P(e,a,n)}c(d,"rename");function K(e,r){r in e||(r="~"+r);let s=e[r];return delete e[r],{[r]:s}}c(K,"dropKey");var m=class extends q{loader;plugins;constructor(e){super(e,"config",{authority:4}),this.loader=e.loader,this.plugins=e.loader.config.plugins,e.console.addListener("manager/app-reload",r=>{this.reloadApp(r)},{authority:4});for(let r of["teleport","reload","unload","remove","group","meta","alias"])e.console.addListener(`manager/${r}`,this[r].bind(this),{authority:4});e.on("config",()=>this.refresh())}getGroup(e,r){let s={...e};for(let t in e){if(t.startsWith("$"))continue;let o=e[t];if(t.split(":",1)[0].replace(/^~/,"")==="group"){let n=r.state[f.kRecord][t];s[t]=this.getGroup(o,n.ctx)}}return s}async get(){let e={...this.loader.config};return e.plugins=this.getGroup(e.plugins,this.loader.entry),e}reloadApp(e){this.loader.config=e,this.loader.config.plugins=this.plugins,this.loader.writeConfig(),this.loader.fullReload()}resolve(e){let r=I(e);e.endsWith("/")&&r.push("");let s=this.loader.entry,t=r.shift();for(;r.length;)s=s.state[f.kRecord][t].ctx,t=r.shift();return[s.state,t]}alias(e,r){let[s,t]=this.resolve(e),o,i=t.split(":",1)[0]+(r?":":"")+r,n=s[f.kRecord],a=n[t];a?(delete n[t],n[i]=a,a.alias=r,a.ctx.emit("internal/fork",a),o=s.config[t]):(i="~"+i,o=s.config["~"+t]),d(s.config,t,i,o),this.loader.writeConfig()}meta(e,r){let[s,t]=this.resolve(e),o=e?s.config[t]:s.config;for(let i of Object.keys(r))r[i]===null?delete o[i]:o[i]=r[i];this.loader.writeConfig()}async reload(e,r,s){let[t,o]=this.resolve(e);s&&this.loader.unloadPlugin(t.ctx,o),await this.loader.reloadPlugin(t.ctx,s||o,r),d(t.config,o,s||o,r),this.loader.writeConfig(),this.refresh()}unload(e,r={},s){let[t,o]=this.resolve(e);this.loader.unloadPlugin(t.ctx,o),d(t.config,o,"~"+(s||o),r),this.loader.writeConfig(),this.refresh()}remove(e){let[r,s]=this.resolve(e);this.loader.unloadPlugin(r.ctx,s),delete r.config[s],delete r.config["~"+s],this.loader.writeConfig(),this.refresh()}async group(e){let[r,s]=this.resolve(e),t=r.config[s]={};await this.loader.reloadPlugin(r.ctx,s,t),this.loader.writeConfig(),this.refresh()}teleport(e,r,s){let[t,o]=this.resolve(e),[i]=this.resolve(r?r+"/":""),n=t[f.kRecord][o];n&&t!==i&&(delete t[f.kRecord][o],i[f.kRecord][o]=n,z(t.disposables,n.dispose),i.disposables.push(n.dispose),n.parent=i.ctx,Object.setPrototypeOf(n.ctx,i.ctx),n.ctx.emit("internal/fork",n),n.runtime.using.some(p=>t[p]!==i[p])&&n.restart());let a=K(t.config,o),l=Object.keys(i.config).slice(s);P(i.config,a,l),this.loader.writeConfig()}};c(m,"ConfigWriter");W(m,"using",["console.packages"]);import{Context as X,pick as Y}from"https://registry.koishi.chat/modules/koishi/index.js";var E=Object.defineProperty,J=(e,r,s)=>r in e?E(e,r,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[r]=s,h=(e,r)=>E(e,"name",{value:r,configurable:!0}),R=(e,r,s)=>(J(e,typeof r!="symbol"?r+"":r,s),s),w=class extends U{constructor(e){super(e,"dependencies",{authority:4}),this.ctx=e}async get(e=!1){let s=(await this.ctx.console.market.prepare()).objects.filter(t=>t.portable);return Object.fromEntries(s.map(t=>[t.name,{request:t.version,resolved:t.version,versions:t.versions,latest:t.version}]))}};h(w,"Installer");R(w,"using",["console.market"]);var V=w,A=class extends v{start(){super.start(),this.refresh()}async collect(){return await(await fetch("https://registry.koishi.chat/play.json")).json()}async get(){let e=await this.prepare();return e?{data:Object.fromEntries(e.objects.map(r=>[r.name,r])),failed:0,total:e.objects.length,progress:e.objects.length}:{data:{},failed:0,total:0,progress:0}}};h(A,"MarketProvider");var x=class extends k{async getManifest(e){return(await this.ctx.console.market.prepare()).objects.find(s=>e===s.name.replace(/(koishi-|^@koishijs\/)plugin-/,""))?.manifest}async get(e=!1){let r=await this.ctx.console.market.prepare(),s=await Promise.all(r.objects.map(async t=>{let o=Y(t,["name","version","description","portable","manifest"]);if(o.shortname=t.name.replace(/(koishi-|^@koishijs\/)plugin-/,""),o.manifest=t.manifest,o.peerDependencies={...t.versions[t.version].peerDependencies},o.peerDependenciesMeta={...t.versions[t.version].peerDependenciesMeta},!o.portable)return;let i=await this.ctx.loader.resolvePlugin(t.shortname);o.schema=i?.Config||i?.schema,o.usage=i?.usage;let n=this.ctx.registry.get(i);return n&&this.parseRuntime(n,o),o}));return s.unshift({name:"",shortname:"",schema:X.Config}),Object.fromEntries(s.filter(t=>t).map(t=>[t.name,t]))}};h(x,"PackageProvider");R(x,"using",["console.market"]);var we="manager",xe=["console"],be=Q.object({});function Z(e,r){e.plugin(V),e.plugin(A),e.plugin(x),e.plugin(m),e.plugin(y),e.console.addEntry(["https://registry.koishi.chat/modules/@koishijs/plugin-market/dist/index.js","https://registry.koishi.chat/modules/@koishijs/plugin-market/dist/style.css"])}h(Z,"apply");export{be as Config,m as ConfigWriter,V as Installer,A as MarketProvider,x as PackageProvider,y as ServiceProvider,Z as apply,we as name,I as splitPath,xe as using};
