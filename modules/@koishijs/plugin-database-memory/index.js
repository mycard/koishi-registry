var St=Object.create;var je=Object.defineProperty;var zt=Object.getOwnPropertyDescriptor;var Mt=Object.getOwnPropertyNames;var Ct=Object.getPrototypeOf,Nt=Object.prototype.hasOwnProperty;var L=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var Bt=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of Mt(t))!Nt.call(e,i)&&i!==r&&je(e,i,{get:()=>t[i],enumerable:!(n=zt(t,i))||n.enumerable});return e};var Rt=(e,t,r)=>(r=e!=null?St(Ct(e)):{},Bt(t||!e||!e.__esModule?je(r,"default",{value:e,enumerable:!0}):r,e));var Je=L((br,He)=>{"use strict";var J=Object.defineProperty,Ft=Object.getOwnPropertyDescriptor,Ut=Object.getOwnPropertyNames,It=Object.prototype.hasOwnProperty,u=(e,t)=>J(e,"name",{value:t,configurable:!0}),qt=(e,t)=>{for(var r in t)J(e,r,{get:t[r],enumerable:!0})},Qt=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of Ut(t))!It.call(e,i)&&i!==r&&J(e,i,{get:()=>t[i],enumerable:!(n=Ft(t,i))||n.enumerable});return e},Lt=e=>Qt(J({},"__esModule",{value:!0}),e),Ee={};qt(Ee,{Time:()=>oe,arrayBufferToBase64:()=>qe,base64ToArrayBuffer:()=>Qe,camelCase:()=>le,camelize:()=>Wt,capitalize:()=>Le,clone:()=>Y,contain:()=>Ce,deduplicate:()=>Fe,deepEqual:()=>H,defineProperty:()=>Me,difference:()=>Be,hyphenate:()=>Yt,intersection:()=>Ne,is:()=>W,isNullable:()=>R,isPlainObject:()=>Pe,makeArray:()=>Ie,noop:()=>ke,omit:()=>ze,paramCase:()=>ue,pick:()=>Se,remove:()=>Ue,sanitize:()=>Ye,snakeCase:()=>We,trimSlash:()=>fe,uncapitalize:()=>Z,union:()=>Re,valueMap:()=>ce});He.exports=Lt(Ee);function ke(){}u(ke,"noop");function R(e){return e==null}u(R,"isNullable");function Pe(e){return e&&typeof e=="object"&&!Array.isArray(e)}u(Pe,"isPlainObject");function ce(e,t){return Object.fromEntries(Object.entries(e).map(([r,n])=>[r,t(n,r)]))}u(ce,"valueMap");function W(e,t){return e in globalThis&&t instanceof globalThis[e]||Object.prototype.toString.call(t).slice(8,-1)===e}u(W,"is");function Y(e){return!e||typeof e!="object"?e:Array.isArray(e)?e.map(Y):W("Date",e)?new Date(e.valueOf()):W("RegExp",e)?new RegExp(e.source,e.flags):ce(e,Y)}u(Y,"clone");function H(e,t,r){return e===t||!r&&R(e)&&R(t)?!0:typeof e!=typeof t||typeof e!="object"||!e||!t?!1:Array.isArray(e)?!Array.isArray(t)||e.length!==t.length?!1:e.every((n,i)=>H(n,t[i])):Array.isArray(t)?!1:Object.keys({...e,...t}).every(n=>H(e[n],t[n]))}u(H,"deepEqual");function Se(e,t,r){if(!t)return{...e};let n={};for(let i of t)(r||i in e)&&(n[i]=e[i]);return n}u(Se,"pick");function ze(e,t){if(!t)return{...e};let r={...e};for(let n of t)Reflect.deleteProperty(r,n);return r}u(ze,"omit");function Me(e,t,r){return Object.defineProperty(e,t,{writable:!0,value:r})}u(Me,"defineProperty");function Ce(e,t){return t.every(r=>e.includes(r))}u(Ce,"contain");function Ne(e,t){return e.filter(r=>t.includes(r))}u(Ne,"intersection");function Be(e,t){return e.filter(r=>!t.includes(r))}u(Be,"difference");function Re(e,t){return Array.from(new Set([...e,...t]))}u(Re,"union");function Fe(e){return[...new Set(e)]}u(Fe,"deduplicate");function Ue(e,t){let r=e.indexOf(t);return r>=0?(e.splice(r,1),!0):!1}u(Ue,"remove");function Ie(e){return Array.isArray(e)?e:R(e)?[]:[e]}u(Ie,"makeArray");function qe(e){if(typeof Buffer<"u")return Buffer.from(e).toString("base64");let t="",r=new Uint8Array(e);for(let n=0;n<r.byteLength;n++)t+=String.fromCharCode(r[n]);return btoa(t)}u(qe,"arrayBufferToBase64");function Qe(e){if(typeof Buffer<"u")return Buffer.from(e,"base64").buffer;let t=atob(e.replace(/\s/g,"")),r=new Uint8Array(t.length);for(let n=0;n<t.length;n++)r[n]=t.charCodeAt(n);return r}u(Qe,"base64ToArrayBuffer");function Le(e){return e.charAt(0).toUpperCase()+e.slice(1)}u(Le,"capitalize");function Z(e){return e.charAt(0).toLowerCase()+e.slice(1)}u(Z,"uncapitalize");function le(e){return e.replace(/[_-][a-z]/g,t=>t.slice(1).toUpperCase())}u(le,"camelCase");function ue(e){return Z(e).replace(/_/g,"-").replace(/.[A-Z]+/g,t=>t[0]+"-"+t.slice(1).toLowerCase())}u(ue,"paramCase");function We(e){return Z(e).replace(/-/g,"_").replace(/.[A-Z]+/g,t=>t[0]+"_"+t.slice(1).toLowerCase())}u(We,"snakeCase");var Wt=le,Yt=ue;function fe(e){return e.replace(/\/$/,"")}u(fe,"trimSlash");function Ye(e){return e.startsWith("/")||(e="/"+e),fe(e)}u(Ye,"sanitize");var oe;(e=>{e.millisecond=1,e.second=1e3,e.minute=e.second*60,e.hour=e.minute*60,e.day=e.hour*24,e.week=e.day*7;let t=new Date().getTimezoneOffset();function r(a){t=a}e.setTimezoneOffset=r,u(r,"setTimezoneOffset");function n(){return t}e.getTimezoneOffset=n,u(n,"getTimezoneOffset");function i(a=new Date,s){return typeof a=="number"&&(a=new Date(a)),s===void 0&&(s=t),Math.floor((a.valueOf()/e.minute-s)/1440)}e.getDateNumber=i,u(i,"getDateNumber");function o(a,s){let g=new Date(a*e.day);return s===void 0&&(s=t),new Date(+g+s*e.minute)}e.fromDateNumber=o,u(o,"fromDateNumber");let c=/\d+(?:\.\d+)?/.source,l=new RegExp(`^${["w(?:eek(?:s)?)?","d(?:ay(?:s)?)?","h(?:our(?:s)?)?","m(?:in(?:ute)?(?:s)?)?","s(?:ec(?:ond)?(?:s)?)?"].map(a=>`(${c}${a})?`).join("")}$`);function h(a){let s=l.exec(a);return s?(parseFloat(s[1])*e.week||0)+(parseFloat(s[2])*e.day||0)+(parseFloat(s[3])*e.hour||0)+(parseFloat(s[4])*e.minute||0)+(parseFloat(s[5])*e.second||0):0}e.parseTime=h,u(h,"parseTime");function v(a){let s=h(a);return s?a=Date.now()+s:/^\d{1,2}(:\d{1,2}){1,2}$/.test(a)?a=`${new Date().toLocaleDateString()}-${a}`:/^\d{1,2}-\d{1,2}-\d{1,2}(:\d{1,2}){1,2}$/.test(a)&&(a=`${new Date().getFullYear()}-${a}`),a?new Date(a):new Date}e.parseDate=v,u(v,"parseDate");function O(a){let s=Math.abs(a);return s>=e.day-e.hour/2?Math.round(a/e.day)+"d":s>=e.hour-e.minute/2?Math.round(a/e.hour)+"h":s>=e.minute-e.second/2?Math.round(a/e.minute)+"m":s>=e.second?Math.round(a/e.second)+"s":a+"ms"}e.format=O,u(O,"format");function y(a,s=2){return a.toString().padStart(s,"0")}e.toDigits=y,u(y,"toDigits");function A(a,s=new Date){return a.replace("yyyy",s.getFullYear().toString()).replace("yy",s.getFullYear().toString().slice(2)).replace("MM",y(s.getMonth()+1)).replace("dd",y(s.getDate())).replace("hh",y(s.getHours())).replace("mm",y(s.getMinutes())).replace("ss",y(s.getSeconds())).replace("SSS",y(s.getMilliseconds(),3))}e.template=A,u(A,"template")})(oe||(oe={}))});var M=L((wr,pt)=>{"use strict";var X=Object.defineProperty,Ht=Object.getOwnPropertyDescriptor,Jt=Object.getOwnPropertyNames,Zt=Object.prototype.hasOwnProperty,f=(e,t)=>X(e,"name",{value:t,configurable:!0}),Vt=(e,t)=>{for(var r in t)X(e,r,{get:t[r],enumerable:!0})},Gt=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of Jt(t))!Zt.call(e,i)&&i!==r&&X(e,i,{get:()=>t[i],enumerable:!(n=Ht(t,i))||n.enumerable});return e},Kt=e=>Gt(X({},"__esModule",{value:!0}),e),Ze={};Vt(Ze,{Time:()=>pe,arrayBufferToBase64:()=>ot,base64ToArrayBuffer:()=>ct,camelCase:()=>de,camelize:()=>Xt,capitalize:()=>lt,clone:()=>G,contain:()=>et,deduplicate:()=>it,deepEqual:()=>K,defineProperty:()=>Te,difference:()=>rt,hyphenate:()=>Tt,intersection:()=>tt,is:()=>V,isNullable:()=>F,isPlainObject:()=>Ge,makeArray:()=>st,noop:()=>Ve,omit:()=>Xe,paramCase:()=>ye,pick:()=>Ke,remove:()=>at,sanitize:()=>ft,snakeCase:()=>ut,trimSlash:()=>me,uncapitalize:()=>T,union:()=>nt,valueMap:()=>he});pt.exports=Kt(Ze);function Ve(){}f(Ve,"noop");function F(e){return e==null}f(F,"isNullable");function Ge(e){return e&&typeof e=="object"&&!Array.isArray(e)}f(Ge,"isPlainObject");function he(e,t){return Object.fromEntries(Object.entries(e).map(([r,n])=>[r,t(n,r)]))}f(he,"valueMap");function V(e,t){return e in globalThis&&t instanceof globalThis[e]||Object.prototype.toString.call(t).slice(8,-1)===e}f(V,"is");function G(e){return!e||typeof e!="object"?e:Array.isArray(e)?e.map(G):V("Date",e)?new Date(e.valueOf()):V("RegExp",e)?new RegExp(e.source,e.flags):he(e,G)}f(G,"clone");function K(e,t,r){return e===t||!r&&F(e)&&F(t)?!0:typeof e!=typeof t||typeof e!="object"||!e||!t?!1:Array.isArray(e)?!Array.isArray(t)||e.length!==t.length?!1:e.every((n,i)=>K(n,t[i])):Array.isArray(t)?!1:Object.keys({...e,...t}).every(n=>K(e[n],t[n]))}f(K,"deepEqual");function Ke(e,t,r){if(!t)return{...e};let n={};for(let i of t)(r||i in e)&&(n[i]=e[i]);return n}f(Ke,"pick");function Xe(e,t){if(!t)return{...e};let r={...e};for(let n of t)Reflect.deleteProperty(r,n);return r}f(Xe,"omit");function Te(e,t,r){return Object.defineProperty(e,t,{writable:!0,value:r})}f(Te,"defineProperty");function et(e,t){return t.every(r=>e.includes(r))}f(et,"contain");function tt(e,t){return e.filter(r=>t.includes(r))}f(tt,"intersection");function rt(e,t){return e.filter(r=>!t.includes(r))}f(rt,"difference");function nt(e,t){return Array.from(new Set([...e,...t]))}f(nt,"union");function it(e){return[...new Set(e)]}f(it,"deduplicate");function at(e,t){let r=e.indexOf(t);return r>=0?(e.splice(r,1),!0):!1}f(at,"remove");function st(e){return Array.isArray(e)?e:F(e)?[]:[e]}f(st,"makeArray");function ot(e){if(typeof Buffer<"u")return Buffer.from(e).toString("base64");let t="",r=new Uint8Array(e);for(let n=0;n<r.byteLength;n++)t+=String.fromCharCode(r[n]);return btoa(t)}f(ot,"arrayBufferToBase64");function ct(e){if(typeof Buffer<"u")return Buffer.from(e,"base64").buffer;let t=atob(e.replace(/\s/g,"")),r=new Uint8Array(t.length);for(let n=0;n<t.length;n++)r[n]=t.charCodeAt(n);return r}f(ct,"base64ToArrayBuffer");function lt(e){return e.charAt(0).toUpperCase()+e.slice(1)}f(lt,"capitalize");function T(e){return e.charAt(0).toLowerCase()+e.slice(1)}f(T,"uncapitalize");function de(e){return e.replace(/[_-][a-z]/g,t=>t.slice(1).toUpperCase())}f(de,"camelCase");function ye(e){return T(e).replace(/_/g,"-").replace(/.[A-Z]+/g,t=>t[0]+"-"+t.slice(1).toLowerCase())}f(ye,"paramCase");function ut(e){return T(e).replace(/-/g,"_").replace(/.[A-Z]+/g,t=>t[0]+"_"+t.slice(1).toLowerCase())}f(ut,"snakeCase");var Xt=de,Tt=ye;function me(e){return e.replace(/\/$/,"")}f(me,"trimSlash");function ft(e){return e.startsWith("/")||(e="/"+e),me(e)}f(ft,"sanitize");var pe;(e=>{e.millisecond=1,e.second=1e3,e.minute=e.second*60,e.hour=e.minute*60,e.day=e.hour*24,e.week=e.day*7;let t=new Date().getTimezoneOffset();function r(a){t=a}e.setTimezoneOffset=r,f(r,"setTimezoneOffset");function n(){return t}e.getTimezoneOffset=n,f(n,"getTimezoneOffset");function i(a=new Date,s){return typeof a=="number"&&(a=new Date(a)),s===void 0&&(s=t),Math.floor((a.valueOf()/e.minute-s)/1440)}e.getDateNumber=i,f(i,"getDateNumber");function o(a,s){let g=new Date(a*e.day);return s===void 0&&(s=t),new Date(+g+s*e.minute)}e.fromDateNumber=o,f(o,"fromDateNumber");let c=/\d+(?:\.\d+)?/.source,l=new RegExp(`^${["w(?:eek(?:s)?)?","d(?:ay(?:s)?)?","h(?:our(?:s)?)?","m(?:in(?:ute)?(?:s)?)?","s(?:ec(?:ond)?(?:s)?)?"].map(a=>`(${c}${a})?`).join("")}$`);function h(a){let s=l.exec(a);return s?(parseFloat(s[1])*e.week||0)+(parseFloat(s[2])*e.day||0)+(parseFloat(s[3])*e.hour||0)+(parseFloat(s[4])*e.minute||0)+(parseFloat(s[5])*e.second||0):0}e.parseTime=h,f(h,"parseTime");function v(a){let s=h(a);return s?a=Date.now()+s:/^\d{1,2}(:\d{1,2}){1,2}$/.test(a)?a=`${new Date().toLocaleDateString()}-${a}`:/^\d{1,2}-\d{1,2}-\d{1,2}(:\d{1,2}){1,2}$/.test(a)&&(a=`${new Date().getFullYear()}-${a}`),a?new Date(a):new Date}e.parseDate=v,f(v,"parseDate");function O(a){let s=Math.abs(a);return s>=e.day-e.hour/2?Math.round(a/e.day)+"d":s>=e.hour-e.minute/2?Math.round(a/e.hour)+"h":s>=e.minute-e.second/2?Math.round(a/e.minute)+"m":s>=e.second?Math.round(a/e.second)+"s":a+"ms"}e.format=O,f(O,"format");function y(a,s=2){return a.toString().padStart(s,"0")}e.toDigits=y,f(y,"toDigits");function A(a,s=new Date){return a.replace("yyyy",s.getFullYear().toString()).replace("yy",s.getFullYear().toString().slice(2)).replace("MM",y(s.getMonth()+1)).replace("dd",y(s.getDate())).replace("hh",y(s.getHours())).replace("mm",y(s.getMinutes())).replace("ss",y(s.getSeconds())).replace("SSS",y(s.getMilliseconds(),3))}e.template=A,f(A,"template")})(pe||(pe={}))});var Ot=L((Or,_t)=>{"use strict";var ne=Object.defineProperty,er=Object.getOwnPropertyDescriptor,tr=Object.getOwnPropertyNames,rr=Object.prototype.hasOwnProperty,m=(e,t)=>ne(e,"name",{value:t,configurable:!0}),nr=(e,t)=>{for(var r in t)ne(e,r,{get:t[r],enumerable:!0})},ir=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of tr(t))!rr.call(e,i)&&i!==r&&ne(e,i,{get:()=>t[i],enumerable:!(n=er(t,i))||n.enumerable});return e},ar=e=>ir(ne({},"__esModule",{value:!0}),e),yt={};nr(yt,{$:()=>p,Database:()=>bt,Driver:()=>wt,Eval:()=>p,Field:()=>re,Model:()=>q,RuntimeError:()=>De,Selection:()=>D,executeEval:()=>d,executeQuery:()=>I,executeSort:()=>gt,executeUpdate:()=>vt,isEvalExpr:()=>xe});_t.exports=ar(yt);var ve=M(),te=M();function _e(e){return typeof e=="string"||typeof e=="number"||typeof e=="boolean"||e instanceof Date}m(_e,"isComparable");var ht="abcdefghijklmnopqrstuvwxyz";function mt(){return Array(8).fill(0).map(()=>ht[Math.floor(Math.random()*ht.length)]).join("")}m(mt,"randomId");function Oe(e){return e instanceof RegExp?e:new RegExp(e)}m(Oe,"makeRegExp");function xe(e){return e&&Object.keys(e).some(t=>t.startsWith("$"))}m(xe,"isEvalExpr");var sr=Symbol("expr"),_r=Symbol("type"),p=m((e,t)=>(0,te.defineProperty)({["$"+e]:t},sr,!0),"Eval"),k={};k.$=ie;function P(e,t){return k[`$${e}`]=t,r=>p(e,r)}m(P,"unary");function x(e,t){return k[`$${e}`]=t,(...r)=>p(e,r)}m(x,"multary");function S(e,t){return k[`$${e}`]=(r,n)=>{let i=d(n,r[0]),o=d(n,r[1]);return(0,te.isNullable)(i)||(0,te.isNullable)(o)?!0:t(i.valueOf(),o.valueOf())},(...r)=>p(e,r)}m(S,"comparator");p.switch=(e,t)=>p("switch",{branches:e,default:t});k.$switch=(e,t)=>{for(let r of e.branches)if(d(t,r.case))return d(t,r.then);return d(t,e.default)};p.if=x("if",([e,t,r],n)=>d(n,e)?d(n,t):d(n,r));p.ifNull=x("ifNull",([e,t],r)=>{var n;return(n=d(r,e))!=null?n:d(r,t)});p.add=x("add",(e,t)=>e.reduce((r,n)=>r+d(t,n),0));p.multiply=x("multiply",(e,t)=>e.reduce((r,n)=>r*d(t,n),1));p.subtract=x("subtract",([e,t],r)=>d(r,e)-d(r,t));p.divide=x("divide",([e,t],r)=>d(r,e)/d(r,t));p.eq=S("eq",(e,t)=>e===t);p.ne=S("ne",(e,t)=>e!==t);p.gt=S("gt",(e,t)=>e>t);p.gte=S("gte",(e,t)=>e>=t);p.lt=S("lt",(e,t)=>e<t);p.lte=S("lte",(e,t)=>e<=t);p.in=x("in",([e,t],r)=>t.includes(d(r,e)));p.nin=x("nin",([e,t],r)=>!t.includes(d(r,e)));p.concat=x("concat",(e,t)=>e.map(r=>d(t,r)).join(""));p.regex=x("regex",([e,t],r)=>Oe(d(r,t)).test(d(r,e)));p.and=x("and",(e,t)=>e.every(r=>d(t,r)));p.or=x("or",(e,t)=>e.some(r=>d(t,r)));p.not=P("not",(e,t)=>!d(t,e));p.sum=P("sum",(e,t)=>t.reduce((r,n)=>r+N(e,n),0));p.avg=P("avg",(e,t)=>t.reduce((r,n)=>r+N(e,n),0)/t.length);p.max=P("max",(e,t)=>Math.max(...t.map(r=>N(e,r))));p.min=P("min",(e,t)=>Math.min(...t.map(r=>N(e,r))));p.count=P("count",(e,t)=>new Set(t.map(r=>N(e,r))).size);function ie(e,t){if(typeof e=="string")return ie(["_",e],t);let[r,n]=e,i=t[r];if(!i)return i;if(n in i)return i[n];let o=Object.keys(i).find(l=>n.startsWith(l+"."))||n.split(".",1)[0],c=n.slice(o.length+1).split(".").filter(Boolean);c.unshift(o);for(let l of c)if(i=i[l],!i)return i;return i}m(ie,"getRecursive");function Ae(e,t){for(let r in e)if(r in k)return k[r](e[r],t);return e}m(Ae,"executeEvalExpr");function N(e,t){return typeof e=="string"?ie(e,t):Ae(e,t)}m(N,"executeAggr");function d(e,t){return _e(t)||(0,te.isNullable)(t)?t:Ae(t,e)}m(d,"executeEval");function vt(e,t,r){for(let n in t){let i=e,o=n.split("."),c=o.pop();for(let l of o)i=i[l]||(i[l]={});i[c]=d({[r]:e,_:e},t[n])}return e}m(vt,"executeUpdate");var U=M(),re;(e=>{e.number=["integer","unsigned","float","double","decimal"],e.string=["char","string","text"],e.boolean=["boolean"],e.date=["timestamp","date","time"],e.object=["list","json"];let t=/^(\w+)(?:\((.+)\))?$/;function r(n){if(typeof n=="function")return{type:"expr",expr:n};if(typeof n!="string")return{initial:null,...n};let i=t.exec(n);if(!i)throw new TypeError("invalid field definition");let o=i[1],c=(i[2]||"").split(","),l={type:o};return l.initial===void 0&&(e.number.includes(l.type)&&(l.initial=0),e.string.includes(l.type)&&(l.initial=""),l.type==="list"&&(l.initial=[]),l.type==="json"&&(l.initial={})),o==="decimal"?(l.precision=+c[0],l.scale=+c[1]):c[0]&&(l.length=+c[0]),l}e.parse=r,m(r,"parse")})(re||(re={}));var q=class{constructor(e){this.name=e,this.fields={},this.autoInc=!1,this.primary="id",this.unique=[],this.foreign={}}extend(e={},t={}){let{primary:r,autoInc:n,unique:i=[],foreign:o}=t;this.primary=r||this.primary,this.autoInc=n||this.autoInc,this.unique.push(...i),Object.assign(this.foreign,o);for(let c in e)this.fields[c]=re.parse(e[c]);this.checkIndex(this.primary),this.unique.forEach(c=>this.checkIndex(c))}checkIndex(e){for(let t of(0,U.makeArray)(e))if(!this.fields[t])throw new TypeError(`missing field definition for index key "${t}"`)}resolveValue(e,t){var r;if((0,U.isNullable)(t))return t;if(((r=this.fields[e])==null?void 0:r.type)==="time"){let n=new Date(0);return n.setHours(t.getHours(),t.getMinutes(),t.getSeconds(),t.getMilliseconds()),n}return t}format(e,t=!0,r="",n={}){let i=Object.keys(this.fields);return Object.entries(e).map(([o,c])=>{if(o=r+o,i.includes(o))n[o]=c;else if(!c||typeof c!="object"||xe(c)){if(i.find(h=>o.startsWith(h+".")))n[o]=c;else if(t)throw new TypeError(`unknown field "${o}" in model ${this.name}`)}else this.format(c,t,o+".",n)}),n}parse(e){var t;let r={};for(let n in e){let i=r,o=n.split(".").reverse(),c="";for(let l=o.length-1;l>0;l--){let h=o[l];c+=h+".",i=(t=i[h])!=null?t:i[h]={}}if(n in e){let l=this.resolveValue(n,e[n]);i[o[0]]=l}}return r}create(e){let t={},r=(0,U.makeArray)(this.primary);for(let n in this.fields){let{initial:i}=this.fields[n];!r.includes(n)&&!(0,U.isNullable)(i)&&(t[n]=(0,U.clone)(i))}return this.parse({...t,...e})}};m(q,"Model");var ee=M(),ge=m((e,t={},r="")=>new Proxy(t,{get(n,i){return typeof i=="symbol"||i in n||i.startsWith("$")?Reflect.get(n,i):ge(e,p("",[e,`${r}${i}`]),`${r}${i}.`)}}),"createRow"),be=class{constructor(e,t){Object.assign(this,t);let r={};if(typeof t.table!="string"&&!(t.table instanceof D))for(let n in t.table)r[n]=ge(n);(0,ee.defineProperty)(this,"driver",e),(0,ee.defineProperty)(this,"row",ge(this.ref,r)),(0,ee.defineProperty)(this,"model",e.model(this.table))}resolveQuery(e={}){if(typeof e=="function")return{$expr:e(this.row)};if(Array.isArray(e)||e instanceof RegExp||["string","number"].includes(typeof e)){let{primary:t}=this.model;if(Array.isArray(t))throw new TypeError("invalid shorthand for composite primary key");return{[t]:e}}return e}resolveField(e){if(typeof e=="string")return this.row[e];if(typeof e=="function")return e(this.row);throw new TypeError("invalid field definition")}resolveFields(e){if(typeof e=="string"&&(e=[e]),Array.isArray(e)){let t=Object.keys(this.model.fields),r=e.flatMap(n=>this.model.fields[n]?n:t.filter(i=>i.startsWith(n+".")));return Object.fromEntries(r.map(n=>[n,this.row[n]]))}else return(0,ee.valueMap)(e,t=>this.resolveField(t))}execute(){return this.driver[this.type](this,...this.args)}};m(be,"Executable");var D=class extends be{constructor(e,t,r){super(e,{type:"get",ref:mt(),table:t,query:null,args:[{sort:[],limit:1/0,offset:0,group:[],having:p.and(),optional:{}}]}),this.tables={},this.tables[this.ref]=this.model,this.query=this.resolveQuery(r),typeof t!="string"&&Object.assign(this.tables,t.tables)}where(e){var t;return(t=this.query).$and||(t.$and=[]),this.query.$and.push(this.resolveQuery(e)),this}limit(...e){return e.length>1&&this.offset(e.shift()),this.args[0].limit=e[0],this}offset(e){return this.args[0].offset=e,this}orderBy(e,t="asc"){return this.args[0].sort.push([this.resolveField(e),t]),this}groupBy(e,...t){this.args[0].fields=this.resolveFields(e),this.args[0].group=Object.keys(this.args[0].fields);let r=typeof t[0]=="function"?void 0:t.shift();return Object.assign(this.args[0].fields,this.resolveFields(r||{})),t[0]&&this.having(t[0]),new D(this.driver,this)}having(e){return this.args[0].having.$and.push(this.resolveField(e)),this}project(e){return this.args[0].fields=this.resolveFields(e),new D(this.driver,this)}_action(e,...t){return new be(this.driver,{...this,type:e,args:t})}evaluate(e){return new D(this.driver,this)._action("eval",this.resolveField(e))}execute(e){return e?this.evaluate(e).execute():super.execute()}};m(D,"Selection");function gt(e,t,r){let{limit:n,offset:i,sort:o}=t;return e.sort((c,l)=>{for(let[h,v]of o){let O=v==="asc"?1:-1,y=d({[r]:c,_:c},h),A=d({[r]:l,_:l},h);if(y<A)return-O;if(y>A)return O}return 0}),e.slice(i,i+n)}m(gt,"executeSort");var bt=class{constructor(){this.tables=Object.create(null),this.drivers=Object.create(null),this.tasks=Object.create(null),this.stashed=new Set}refresh(){for(let e in this.tables)this.tasks[e]=this.prepare(e)}getDriver(e){return Object.values(this.drivers)[0]}async prepare(e){return this.stashed.add(e),await this.tasks[e],new Promise(async t=>{Promise.resolve().then(async()=>{var r;this.stashed.delete(e)&&await((r=this.getDriver(e))==null?void 0:r.prepare(e)),t()})})}extend(e,t,r={}){let n=this.tables[e];n||(n=this.tables[e]=new q(e)),n.extend(t,r),this.tasks[e]=this.prepare(e)}select(e,t){return new D(this.getDriver(e),e,t)}join(e,t,r){if(Array.isArray(e)){let n=new D(this.getDriver(e[0]),Object.fromEntries(e.map(i=>[i,i])));return typeof t=="function"&&(n.args[0].having=p.and(t(...e.map(i=>n.row[i])))),n.args[0].optional=Object.fromEntries(e.map((i,o)=>[i,r?.[o]])),n}else{let n=new D(this.getDriver(e[0]),e);return typeof t=="function"&&(n.args[0].having=p.and(t(n.row))),n.args[0].optional=r,n}}async get(e,t,r){await this.tasks[e],Array.isArray(r)?r={fields:r}:r||(r={});let n=this.select(e,t);if(r.fields&&n.project(r.fields),r.limit!==void 0&&n.limit(r.limit),r.offset!==void 0&&n.offset(r.offset),r.sort)for(let i in r.sort)n.orderBy(i,r.sort[i]);return n.execute()}async eval(e,t,r){return await this.tasks[e],this.select(e,r).execute(typeof t=="function"?t:()=>t)}async set(e,t,r){await this.tasks[e];let n=this.select(e,t);if(typeof r=="function"&&(r=r(n.row)),(0,ve.makeArray)(n.model.primary).some(o=>o in r))throw new TypeError("cannot modify primary key");await n._action("set",n.model.format(r)).execute()}async remove(e,t){await this.tasks[e],await this.select(e,t)._action("remove").execute()}async create(e,t){await this.tasks[e];let r=this.select(e);return r._action("create",r.model.create(t)).execute()}async upsert(e,t,r){await this.tasks[e];let n=this.select(e);typeof t=="function"&&(t=t(n.row)),t=t.map(i=>n.model.format(i)),r=(0,ve.makeArray)(r||n.model.primary),await n._action("upsert",t,r).execute()}async stopAll(){let e=Object.values(this.drivers);this.drivers=Object.create(null),await Promise.all(e.map(t=>t.stop()))}async drop(e){await this.getDriver(e).drop(e)}async dropAll(){await Promise.all(Object.values(this.drivers).map(e=>e.drop()))}async stats(){let e={size:0,tables:{}};return await Promise.all(Object.values(this.drivers).map(async t=>{let{size:r=0,tables:n}=await t.stats();e.size+=r,Object.assign(e.tables,n)})),e}};m(bt,"Database");var wt=class{constructor(e){this.database=e}model(e){if(typeof e=="string"){let r=this.database.tables[e];if(r)return r;throw new TypeError(`unknown table name "${e}"`)}if(e instanceof D){if(!e.args[0].fields)return e.model;let r=new q("temp");return r.fields=(0,ve.valueMap)(e.args[0].fields,(n,i)=>({type:"expr"})),r}let t=new q("temp");for(let r in e){let n=this.model(e[r]);for(let i in n.fields)t.fields[`${r}.${i}`]={type:"expr",expr:{$:[r,i]}}}return t}};m(wt,"Driver");var De=class extends Error{constructor(e,t){super(t||e.replace("-"," ")),this.code=e,this.name="RuntimeError"}static check(e,t){return e instanceof De?!t||e.message===t:!1}};m(De,"RuntimeError");var we=M(),dt={$or:(e,t)=>e.reduce((r,n)=>r||C(n,t),!1),$and:(e,t)=>e.reduce((r,n)=>r&&C(n,t),!0),$not:(e,t)=>!C(e,t),$exists:(e,t)=>e!==(0,we.isNullable)(t),$eq:(e,t)=>t.valueOf()===e.valueOf(),$ne:(e,t)=>t.valueOf()!==e.valueOf(),$gt:(e,t)=>t.valueOf()>e.valueOf(),$gte:(e,t)=>t.valueOf()>=e.valueOf(),$lt:(e,t)=>t.valueOf()<e.valueOf(),$lte:(e,t)=>t.valueOf()<=e.valueOf(),$in:(e,t)=>e.includes(t),$nin:(e,t)=>!e.includes(t),$regex:(e,t)=>Oe(e).test(t),$regexFor:(e,t)=>new RegExp(t,"i").test(e),$bitsAllSet:(e,t)=>(e&t)===e,$bitsAllClear:(e,t)=>(e&t)===0,$bitsAnySet:(e,t)=>(e&t)!==0,$bitsAnyClear:(e,t)=>(e&t)!==e,$el:(e,t)=>t.some(r=>C(e,r)),$size:(e,t)=>t.length===e};function C(e,t){if(Array.isArray(e))return e.includes(t);if(e instanceof RegExp)return e.test(t);if(_e(e))return t.valueOf()===e.valueOf();if((0,we.isNullable)(e))return(0,we.isNullable)(t);for(let r in e)if(r in dt&&!dt[r](e[r],t))return!1;return!0}m(C,"executeFieldQuery");function I(e,t,r){return Object.entries(t).every(([i,o])=>{if(i==="$and")return o.reduce((c,l)=>c&&I(e,l,r),!0);if(i==="$or")return o.reduce((c,l)=>c||I(e,l,r),!1);if(i==="$not")return!I(e,o,r);if(i==="$expr")return d({[r]:e,_:e},o);try{return C(o,e[i])}catch{return!1}})}m(I,"executeQuery")});var Et=L((kr,jt)=>{"use strict";var ae=Object.defineProperty,or=Object.getOwnPropertyDescriptor,cr=Object.getOwnPropertyNames,lr=Object.prototype.hasOwnProperty,xt=(e,t)=>ae(e,"name",{value:t,configurable:!0}),ur=(e,t)=>{for(var r in t)ae(e,r,{get:t[r],enumerable:!0})},fr=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of cr(t))!lr.call(e,i)&&i!==r&&ae(e,i,{get:()=>t[i],enumerable:!(n=or(t,i))||n.enumerable});return e},pr=e=>fr(ae({},"__esModule",{value:!0}),e),At=(e,t,r)=>{if(!t.has(e))throw TypeError("Cannot "+r)},Q=(e,t,r)=>(At(e,t,"read from private field"),r?r.call(e):t.get(e)),hr=(e,t,r)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,r)},dr=(e,t,r,n)=>(At(e,t,"write to private field"),n?n.call(e,r):t.set(e,r),r),Dt={};ur(Dt,{default:()=>yr});jt.exports=pr(Dt);var z=Je(),w=Ot(),E,$t=class extends w.Driver{constructor(e,t){super(e),this.database=e,this.config=t,hr(this,E,{_fields:[]})}async prepare(e){}async start(){}async $save(e){}async stop(){}table(e,t){var r,n;if(typeof e=="string")return(r=Q(this,E))[e]||(r[e]=[]);if(!(e instanceof w.Selection)){let g=Object.entries(e).map(([_,b])=>[_,this.table(b)]),j=xt(_=>{if(!_.length)return[];let[[b,B],...$e]=_;return $e.length?B.flatMap(se=>j($e).map(Pt=>({...Pt,[b]:se}))):B.map(se=>({[b]:se}))},"catesian");return j(g).filter(_=>(0,w.executeEval)(_,t))}let{ref:i,query:o,table:c,args:l,model:h}=e,{fields:v,group:O,having:y}=e.args[0],A=this.table(c,y).filter(g=>(0,w.executeQuery)(g,o,i)),a=[],s=O.length?(0,z.pick)(v,O):v;for(let g of(0,w.executeSort)(A,l[0],i)){g=h.format(g,!1);for(let b in h.fields)(n=g[b])!=null||(g[b]=null);let j=g;v&&(j=(0,z.valueMap)(s,b=>(0,w.executeEval)({[i]:g},b)));let _=a.find(b=>{if(!s)return!1;for(let B in s)if(b.index[B]!==j[B])return!1;return!0});_||(_={index:j,table:[]},a.push(_)),_.table.push(g)}return a.map(({index:g,table:j})=>{if(O.length){if(y&&!(0,w.executeEval)(j.map(b=>({[i]:b,_:b})),y))return;for(let _ in(0,z.omit)(v,O))g[_]=(0,w.executeEval)(j.map(b=>({[i]:b,_:b})),v[_])}return h.parse(g)}).filter(Boolean)}async drop(e){e?delete Q(this,E)[e]:dr(this,E,{_fields:[]})}async stats(){return{}}async get(e){return this.table(e)}async eval(e,t){let{query:r,table:n}=e,i=typeof n=="string"?e.ref:n.ref,o=this.table(n).filter(c=>(0,w.executeQuery)(c,r,i));return(0,w.executeEval)(o.map(c=>({[i]:c,_:c})),t)}async set(e,t){let{table:r,ref:n,query:i}=e;this.table(r).filter(o=>(0,w.executeQuery)(o,i,n)).forEach(o=>(0,w.executeUpdate)(o,t,n)),this.$save(r)}async remove(e){let{ref:t,query:r,table:n}=e;Q(this,E)[n]=this.table(n).filter(i=>!(0,w.executeQuery)(i,r,t)),this.$save(n)}async create(e,t){let{table:r,model:n}=e,{primary:i,autoInc:o}=n,c=this.table(r);if(!Array.isArray(i)&&o&&!(i in t)){let h=Q(this,E)._fields.find(v=>v.table===r&&v.field===i);h||(h={table:r,field:i,autoInc:0},Q(this,E)._fields.push(h)),h.autoInc+=1,t[i]=h.autoInc}else if((await this.database.get(r,(0,z.pick)(t,(0,z.makeArray)(i)))).length)throw new w.RuntimeError("duplicate-entry");let l=n.create(t);return c.push(l),this.$save(r),(0,z.clone)(l)}async upsert(e,t,r){let{table:n,model:i,ref:o}=e;for(let c of t){let l=this.table(n).find(h=>r.every(v=>h[v]===c[v]));if(l)(0,w.executeUpdate)(l,c,o);else{let h=(0,w.executeUpdate)(i.create(),c,o);await this.database.create(n,h).catch(z.noop)}}this.$save(n)}};xt($t,"MemoryDriver");E=new WeakMap;var yr=$t});var kt=Rt(Et(),1);import{defineDriver as mr,Schema as vr}from"https://registry.koishi.chat/modules/koishi/index.js";var zr=mr(kt.default,vr.object({}));export{zr as default};
