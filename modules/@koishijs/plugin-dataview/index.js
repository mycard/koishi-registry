import{makeArray as u,Schema as b}from"https://registry.koishi.chat/modules/koishi/index.js";import{DataService as m}from"https://registry.koishi.chat/modules/@koishijs/plugin-console/index.js";var o=Object.defineProperty,f=(t,r,e)=>r in t?o(t,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[r]=e,n=(t,r)=>o(t,"name",{value:r,configurable:!0}),d=(t,r,e)=>(f(t,typeof r!="symbol"?r+"":r,e),e);function c(t){return t instanceof Date?`"d${t.toJSON()}"`:JSON.stringify(t,(r,e)=>{if(typeof e=="string")return"s"+e;if(typeof e=="object"){if(e instanceof Date)return"d"+new Date(e).toJSON();if(e===null)return null;let s=Array.isArray(e)?[]:{};for(let a in e)e[a]instanceof Date?(s[a]=new Date(e[a]),s[a].toJSON=void 0):s[a]=e[a];return s}return e})}n(c,"serialize");function l(t){if(t!==void 0)return JSON.parse(t,(r,e)=>typeof e=="string"?e[0]==="s"?e.slice(1):new Date(e.slice(1)):e)}n(l,"deserialize");var i=class extends m{task;addListener(t,r=!1){this.ctx.console.addListener(`database/${t}`,async(...e)=>{let s=await this.ctx.database[t](...e.map(l));return r&&this.refresh(),s===void 0?s:c(s)},{authority:4})}constructor(t){super(t,"database",{authority:4}),t.console.addEntry(["https://registry.koishi.chat/modules/@koishijs/plugin-dataview/dist/index.js","https://registry.koishi.chat/modules/@koishijs/plugin-dataview/dist/style.css"]),this.addListener("create",!0),this.addListener("eval",!0),this.addListener("get"),this.addListener("remove",!0),this.addListener("set"),this.addListener("stats"),this.addListener("upsert",!0),t.on("model",()=>this.refresh())}async getInfo(){let t=await this.ctx.database.stats(),r={tables:{},...t},e=r.tables;r.tables={};for(let s in this.ctx.model.tables)r.tables[s]={...this.ctx.model.tables[s],...e[s]},r.tables[s].primary=u(r.tables[s].primary);return r.tables=Object.fromEntries(Object.entries(r.tables).sort(([s],[a])=>s.localeCompare(a))),r}get(t=!1){return t&&delete this.task,this.task||=this.getInfo()}};n(i,"DatabaseProvider");d(i,"filter",!1);d(i,"using",["console","database"]);(t=>{t.Config=b.object({})})(i||(i={}));var _=i;export{_ as default,l as deserialize,c as serialize};
