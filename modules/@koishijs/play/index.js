import{makeArray as S}from"https://registry.koishi.chat/modules/@koishijs/core/index.js";import{Context as b,interpolate as R,isNullable as g,Logger as P,resolveConfig as $,valueMap as k}from"https://registry.koishi.chat/modules/@koishijs/core/index.js";var m=Object.defineProperty,_=(e,r,t)=>r in e?m(e,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[r]=t,d=(e,r)=>m(e,"name",{value:r,configurable:!0}),v=(e,r,t)=>(_(e,typeof r!="symbol"?r+"":r,t),t);function h(e){return e?.default||e}d(h,"unwrapExports");function f(e,r=!1){let t={},i={};for(let[n,a]of Object.entries(e||{}))n.startsWith("$")?i[n]=a:t[n]=a;return[r?e:t,i]}d(f,"separate");var u=Symbol("update");b.service("loader");var c=new P("app"),j={name:"group",reusable:!0,apply(e,r){e.scope[l.kRecord]||=Object.create(null);for(let t in r||{})t.startsWith("~")||t.startsWith("$")||e.scope.ensure(async()=>{await e.loader.reloadPlugin(e,t,r[t])});e.accept(t=>{let i=e.scope.config;for(let n in{...i,...t}){if(n.startsWith("~")||n.startsWith("$"))continue;e.scope[l.kRecord][n]?n in t?e.loader.reloadPlugin(e,n,t[n]||{}):e.loader.unloadPlugin(e,n):e.loader.reloadPlugin(e,n,t[n])}},{passive:!0})}},o=class{envData;ctxData={};app;baseDir;config;entry;suspend=!1;filename;writable=!0;envfile;cache=Object.create(null);interpolate(e){return this.writable?typeof e=="string"?R(e,this.ctxData,/\$\{\{(.+?)\}\}/g):!e||typeof e!="object"?e:Array.isArray(e)?e.map(r=>this.interpolate(r)):k(e,r=>this.interpolate(r)):e}async forkPlugin(e,r,t){let i=await this.resolvePlugin(e);if(i)return $(i,r),t.plugin(i,this.interpolate(r))}isTruthyLike(e){return g(e)?!0:!!this.interpolate(`\${{ ${e} }}`)}async reloadPlugin(e,r,t){let i=e.scope[o.kRecord][r],n=r.split(":",1)[0],[a,s]=f(t,n==="group");if(i){if(!this.isTruthyLike(s.$if)){this.unloadPlugin(e,r);return}i[u]=!0,i.update(a)}else{if(!this.isTruthyLike(s.$if))return;c.info("apply plugin %c",r);let p=e.extend();if(n==="group"?i=p.plugin(j,a):i=await this.forkPlugin(n,a,p),!i)return;i.alias=r.slice(n.length+1),e.scope[o.kRecord][r]=i}return i.parent.filter=p=>e.filter(p)&&(g(s.$filter)||p.resolve(s.$filter)),i}unloadPlugin(e,r){let t=e.scope[o.kRecord][r];t&&(t.dispose(),delete e.scope[o.kRecord][r],c.info("unload plugin %c",r))}async createApp(){let e=this.app=new b(this.interpolate(this.config));e.loader=this,e.baseDir=this.baseDir,e.envData=this.envData,e.scope[o.kRecord]=Object.create(null);let r=await this.reloadPlugin(e,"group:entry",this.config.plugins);return this.entry=r.ctx,e.accept(["plugins"],t=>{this.reloadPlugin(e,"group:entry",t.plugins)},{passive:!0}),e.on("dispose",()=>{this.fullReload()}),e.on("internal/update",t=>{let i=t.parent.scope[o.kRecord];if(i)for(let n in i)i[n]===t&&c.info("reload plugin %c",n)}),e.on("internal/before-update",(t,i)=>{if(t[u])return delete t[u];let n=t.parent.scope[o.kRecord];if(n)for(let a in n){if(n[a]!==t)continue;let s=t.runtime.schema?.simplify;t.parent.scope.config[a]={...f(t.parent.scope.config[a])[1],...s?s(i):i}}}),e}},l=o;d(l,"Loader");v(l,"kRecord",Symbol.for("koishi.loader.record"));v(l,"exitCode",51);var I=Object.defineProperty,y=(e,r)=>I(e,"name",{value:r,configurable:!0});function L(e){if(e[0]==="@"){let[r,t]=e.split("/");return[`${r}/koishi-plugin-${t}`]}else return[`@koishijs/plugin-${e}`,`koishi-plugin-${e}`]}y(L,"resolveName");var w=class extends l{fs=new Filer.FileSystem({name:"play.koishi.chat"});path=Filer.path;envData={};config={plugins:{}};_initTask;async prepare(){let e=await fetch("https://registry.koishi.chat/play.json").then(r=>r.json());for(let r of e.objects)this.cache[r.shortname]=`https://registry.koishi.chat/modules/${r.name}/index.js`}readConfig(){return{}}writeConfig(){this.app.emit("config")}async resolve(e){return await(this._initTask||=this.prepare()),this.cache[e]}async resolvePlugin(e){await(this._initTask||=this.prepare());let r=S(this.cache[e]);for(let t of r)try{return h(await import(t))}catch{}}fullReload(){}};y(w,"BrowserLoader");var N=new w;export{l as Loader,N as default,h as unwrapExports};
