var Kt=Object.defineProperty,v=(t,e)=>Kt(t,"name",{value:e,configurable:!0});function Vt(){}v(Vt,"noop");function A(t){return t==null}v(A,"isNullable");function Y(t){return t&&typeof t=="object"&&!Array.isArray(t)}v(Y,"isPlainObject");function G(t,e){return Object.fromEntries(Object.entries(t).map(([s,r])=>[s,e(r,s)]))}v(G,"valueMap");function K(t,e){return t in globalThis&&e instanceof globalThis[t]||Object.prototype.toString.call(e).slice(8,-1)===t}v(K,"is");function et(t){return!t||typeof t!="object"?t:Array.isArray(t)?t.map(et):K("Date",t)?new Date(t.valueOf()):K("RegExp",t)?new RegExp(t.source,t.flags):G(t,et)}v(et,"clone");function J(t,e,s){return t===e||!s&&A(t)&&A(e)?!0:typeof t!=typeof e||typeof t!="object"||!t||!e?!1:Array.isArray(t)?!Array.isArray(e)||t.length!==e.length?!1:t.every((r,a)=>J(r,e[a])):Array.isArray(e)?!1:Object.keys({...t,...e}).every(r=>J(t[r],e[r]))}v(J,"deepEqual");function rt(t,e,s){if(!e)return{...t};let r={};for(let a of e)(s||a in t)&&(r[a]=t[a]);return r}v(rt,"pick");function Yt(t,e){if(!e)return{...t};let s={...t};for(let r of e)Reflect.deleteProperty(s,r);return s}v(Yt,"omit");function $(t,e,s){return Object.defineProperty(t,e,{writable:!0,value:s})}v($,"defineProperty");function Gt(t,e){return e.every(s=>t.includes(s))}v(Gt,"contain");function Qt(t,e){return t.filter(s=>e.includes(s))}v(Qt,"intersection");function Zt(t,e){return t.filter(s=>!e.includes(s))}v(Zt,"difference");function Xt(t,e){return Array.from(new Set([...t,...e]))}v(Xt,"union");function te(t){return[...new Set(t)]}v(te,"deduplicate");function z(t,e){let s=t.indexOf(e);return s>=0?(t.splice(s,1),!0):!1}v(z,"remove");function yt(t){return Array.isArray(t)?t:A(t)?[]:[t]}v(yt,"makeArray");function mt(t){if(typeof Buffer<"u")return Buffer.from(t).toString("base64");let e="",s=new Uint8Array(t);for(let r=0;r<s.byteLength;r++)e+=String.fromCharCode(s[r]);return btoa(e)}v(mt,"arrayBufferToBase64");function gt(t){if(typeof Buffer<"u")return Buffer.from(t,"base64").buffer;let e=atob(t.replace(/\s/g,"")),s=new Uint8Array(e.length);for(let r=0;r<e.length;r++)s[r]=e.charCodeAt(r);return s}v(gt,"base64ToArrayBuffer");function ee(t){return t.charAt(0).toUpperCase()+t.slice(1)}v(ee,"capitalize");function bt(t){return t.charAt(0).toLowerCase()+t.slice(1)}v(bt,"uncapitalize");function Ct(t){return t.replace(/[_-][a-z]/g,e=>e.slice(1).toUpperCase())}v(Ct,"camelCase");function Et(t){return bt(t).replace(/_/g,"-").replace(/.[A-Z]+/g,e=>e[0]+"-"+e.slice(1).toLowerCase())}v(Et,"paramCase");function re(t){return bt(t).replace(/-/g,"_").replace(/.[A-Z]+/g,e=>e[0]+"_"+e.slice(1).toLowerCase())}v(re,"snakeCase");var st=Ct,Nt=Et;function ot(t){return t.replace(/\/$/,"")}v(ot,"trimSlash");function se(t){return t.startsWith("/")||(t="/"+t),ot(t)}v(se,"sanitize");var V;(t=>{t.millisecond=1,t.second=1e3,t.minute=t.second*60,t.hour=t.minute*60,t.day=t.hour*24,t.week=t.day*7;let e=new Date().getTimezoneOffset();function s(o){e=o}t.setTimezoneOffset=s,v(s,"setTimezoneOffset");function r(){return e}t.getTimezoneOffset=r,v(r,"getTimezoneOffset");function a(o=new Date,c){return typeof o=="number"&&(o=new Date(o)),c===void 0&&(c=e),Math.floor((o.valueOf()/t.minute-c)/1440)}t.getDateNumber=a,v(a,"getDateNumber");function u(o,c){let l=new Date(o*t.day);return c===void 0&&(c=e),new Date(+l+c*t.minute)}t.fromDateNumber=u,v(u,"fromDateNumber");let p=/\d+(?:\.\d+)?/.source,d=new RegExp(`^${["w(?:eek(?:s)?)?","d(?:ay(?:s)?)?","h(?:our(?:s)?)?","m(?:in(?:ute)?(?:s)?)?","s(?:ec(?:ond)?(?:s)?)?"].map(o=>`(${p}${o})?`).join("")}$`);function S(o){let c=d.exec(o);return c?(parseFloat(c[1])*t.week||0)+(parseFloat(c[2])*t.day||0)+(parseFloat(c[3])*t.hour||0)+(parseFloat(c[4])*t.minute||0)+(parseFloat(c[5])*t.second||0):0}t.parseTime=S,v(S,"parseTime");function f(o){let c=S(o);return c?o=Date.now()+c:/^\d{1,2}(:\d{1,2}){1,2}$/.test(o)?o=`${new Date().toLocaleDateString()}-${o}`:/^\d{1,2}-\d{1,2}-\d{1,2}(:\d{1,2}){1,2}$/.test(o)&&(o=`${new Date().getFullYear()}-${o}`),o?new Date(o):new Date}t.parseDate=f,v(f,"parseDate");function y(o){let c=Math.abs(o);return c>=t.day-t.hour/2?Math.round(o/t.day)+"d":c>=t.hour-t.minute/2?Math.round(o/t.hour)+"h":c>=t.minute-t.second/2?Math.round(o/t.minute)+"m":c>=t.second?Math.round(o/t.second)+"s":o+"ms"}t.format=y,v(y,"format");function n(o,c=2){return o.toString().padStart(c,"0")}t.toDigits=n,v(n,"toDigits");function i(o,c=new Date){return o.replace("yyyy",c.getFullYear().toString()).replace("yy",c.getFullYear().toString().slice(2)).replace("MM",n(c.getMonth()+1)).replace("dd",n(c.getDate())).replace("hh",n(c.getHours())).replace("mm",n(c.getMinutes())).replace("ss",n(c.getSeconds())).replace("SSS",n(c.getMilliseconds(),3))}t.template=i,v(i,"template")})(V||(V={}));var Dt=Object.defineProperty,ne=(t,e,s)=>e in t?Dt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,N=(t,e)=>Dt(t,"name",{value:e,configurable:!0}),B=(t,e,s)=>(ne(t,typeof e!="symbol"?e+"":e,s),s);function wt(t){return t!==null&&t!==!1&&t!==void 0}N(wt,"isBailed");var vt=class{constructor(t){this.root=t,$(this,x.current,t),$(this.on("internal/hook",function(e,s,r){let a=r?"unshift":"push",{scope:u}=this[x.current],{runtime:p,disposables:d}=u;if(e==="ready"&&this.isActive)u.ensure(async()=>s());else{if(e==="dispose")return d[a](s),$(s,"name","event <dispose>"),()=>z(d,s);if(e==="fork")return p.forkables[a](s),u.collect("event <fork>",()=>z(p.forkables,s))}}),x.static,t.scope)}isActive=!1;_tasks=new Set;_hooks={};queue(t){this[x.current].scope.ensure(async()=>t)}async flush(){for(;this._tasks.size;)await Promise.all(Array.from(this._tasks))}*getHooks(t,e){let s=this._hooks[t]||[];for(let[r,a]of s.slice()){let u=e?.[x.filter];u&&!u.call(e,r)||(yield a)}}async parallel(...t){let e=typeof t[0]=="object"?t.shift():null,s=t.shift();await Promise.all([...this.getHooks(s,e)].map(async r=>{await r.apply(e,t)}))}emit(...t){let e=typeof t[0]=="object"?t.shift():null,s=t.shift();for(let r of this.getHooks(s,e))r.apply(e,t)}async serial(...t){let e=typeof t[0]=="object"?t.shift():null,s=t.shift();for(let r of this.getHooks(s,e)){let a=await r.apply(e,t);if(wt(a))return a}}bail(...t){let e=typeof t[0]=="object"?t.shift():null,s=t.shift();for(let r of this.getHooks(s,e)){let a=r.apply(e,t);if(wt(a))return a}}register(t,e,s,r){let a=this.root.config.maxListeners;e.length>=a&&this.root.emit("internal/warning",`max listener count (${a}) for ${t} exceeded, which may be caused by a memory leak`);let u=this[x.current];return e[r?"unshift":"push"]([u,s]),u.state.collect(t,()=>this.unregister(e,s))}unregister(t,e){let s=t.findIndex(([r,a])=>a===e);if(s>=0)return t.splice(s,1),!0}on(t,e,s=!1){let r=this.bail(this,"internal/hook",t,e,s);if(r)return r;let a=this._hooks[t]||=[],u=typeof t=="string"?`event <${t}>`:"event (Symbol)";return this.register(u,a,e,s)}once(t,e,s=!1){let r=this.on(t,function(...a){return r(),e.apply(this,a)},s);return r}off(t,e){return this.unregister(this._hooks[t]||[],e)}async start(){this.isActive=!0;let t=this._hooks.ready||[];for(;t.length;){let[e,s]=t.shift();e.scope.ensure(async()=>s())}await this.flush()}async stop(){this.isActive=!1,this.root.scope.reset()}};N(vt,"Lifecycle");B(vt,"methods",["on","once","off","before","after","parallel","emit","serial","bail","start","stop"]);function St(t){return!(!t.prototype||t.prototype.constructor!==t)}N(St,"isConstructor");function ct(t){return Object.getPrototypeOf(t).constructor}N(ct,"getConstructor");function nt(t,e){if(e===!1)return;e===!0&&(e=void 0),e??={};let s=t.Config||t.schema;return s&&t.schema!==!1&&(e=s(e)),e}N(nt,"resolveConfig");var kt=class{constructor(t,e){this.parent=t,this.config=e,this.uid=t.registry?t.registry.counter:0,this.ctx=this.context=t.extend({scope:this}),this.proxy=new Proxy({},{get:(s,r)=>Reflect.get(this.config,r)})}uid;ctx;disposables=[];error;status="pending";proxy;context;acceptors=[];tasks=new Set;hasError=!1;get _config(){return this.runtime.isReactive?this.proxy:this.config}collect(t,e){let s=$(()=>(z(this.disposables,s),e()),"name",t);return this.disposables.push(s),s}restart(){this.reset(),this.start()}_getStatus(){return this.uid===null?"disposed":this.hasError?"failed":this.tasks.size?"loading":this.ready?"active":"pending"}_updateStatus(t){let e=this.status;t?.(),this.status=this._getStatus(),e!==this.status&&this.context.emit("internal/status",this,e)}ensure(t){let e=t().catch(s=>{this.context.emit("internal/warning",s),this.cancel(s)}).finally(()=>{this._updateStatus(()=>this.tasks.delete(e)),this.context.events._tasks.delete(e)});this._updateStatus(()=>this.tasks.add(e)),this.context.events._tasks.add(e)}cancel(t){this.error=t,this._updateStatus(()=>this.hasError=!0),this.reset()}setup(){this.runtime.using.length&&($(this.context.on("internal/before-service",t=>{this.runtime.using.includes(t)&&(this._updateStatus(),this.reset())}),x.static,this),$(this.context.on("internal/service",t=>{this.runtime.using.includes(t)&&this.start()}),x.static,this))}get ready(){return this.runtime.using.every(t=>this.ctx[t])}reset(){this.disposables=this.disposables.splice(0,1/0).filter(t=>{if(this.uid!==null&&t[x.static]===this)return!0;t()})}accept(...t){let e=Array.isArray(t[0])?t.shift():null,s={keys:e,callback:t[0],...t[1]};return this.acceptors.push(s),s.immediate&&s.callback?.(this.config),this.collect(`accept <${e?.join(", ")||"*"}>`,()=>z(this.acceptors,s))}decline(t){return this.accept(t,()=>!0)}checkUpdate(t,e){if(e)return[!0,!0];if(e===!1)return[!1,!1];let s=Object.create(null),r=N(S=>{let f=s[S]??=!J(this.config[S],t[S]);return u||=f,f},"checkPropertyUpdate"),a=new Set,u=!1,p=!1,d=this.runtime.isReactive||null;for(let{keys:S,callback:f,passive:y}of this.acceptors){if(!S)d||=!y;else if(y)S?.forEach(i=>a.add(i));else{let i=!1;for(let o of S)i||=r(o);if(!i)continue}f?.(t)&&(p=!0)}for(let S in{...this.config,...t})if(d!==!1&&!(S in s)&&!a.has(S)){let f=r(S);d===null&&(p||=f)}return[u,p]}};N(kt,"EffectScope");var Rt=class extends kt{constructor(t,e,s){super(t,e),this.runtime=s,this.dispose=$(t.scope.collect(`fork <${t.runtime.name}>`,()=>{this.uid=null,this.reset();let r=z(s.disposables,this.dispose);return z(s.children,this)&&!s.children.length&&t.registry.delete(s.plugin),this.context.emit("internal/fork",this),r}),x.static,s),s.children.push(this),s.disposables.push(this.dispose),this.context.emit("internal/fork",this),s.isReusable&&this.setup(),this.start()}dispose;start(){if(this.ready){this._updateStatus(()=>this.hasError=!1);for(let t of this.runtime.forkables)this.ensure(async()=>t(this.context,this._config))}}update(t,e){let s=this.config,r=this.runtime.isForkable?this:this.runtime;if(r.config!==s)return;let a=nt(this.runtime.plugin,t),[u,p]=r.checkUpdate(a,e);this.context.emit("internal/before-update",this,t),this.config=a,r.config=a,u&&this.context.emit("internal/update",this,s),p&&r.restart()}};N(Rt,"ForkScope");var xt=class extends kt{constructor(t,e,s){super(t[x.current],s),this.plugin=e,t.set(e,this),e&&this.setup()}runtime=this;schema;using=[];forkables=[];children=[];isReusable=!1;isReactive=!1;get isForkable(){return this.forkables.length>0}get name(){if(!this.plugin)return"root";let{name:t}=this.plugin;return!t||t==="apply"?"anonymous":t}fork(t,e){return new Rt(t,e,this)}dispose(){return this.uid=null,this.reset(),this.context.emit("internal/runtime",this),!0}setup(){this.schema=this.plugin.Config||this.plugin.schema,this.using=this.plugin.using||[],this.isReusable=this.plugin.reusable,this.isReactive=this.plugin.reactive,this.context.emit("internal/runtime",this),this.isReusable?this.forkables.push(this.apply):super.setup(),this.restart()}apply=(t,e)=>{let s=this.plugin;if(typeof s!="function")this.ensure(async()=>s.apply(t,e));else if(St(s)){let r=new s(t,e),a=r[x.immediate];a&&(t[a]=r),r.fork&&this.forkables.push(r.fork.bind(r))}else this.ensure(async()=>s(t,e))};reset(){super.reset();for(let t of this.children)t.reset()}start(){if(this.ready){this._updateStatus(()=>this.hasError=!1),!this.isReusable&&this.plugin&&this.apply(this.context,this._config);for(let t of this.children)t.start()}}update(t,e){this.isForkable&&this.context.emit("internal/warning",`attempting to update forkable plugin "${this.plugin.name}", which may lead to unexpected behavior`);let s=this.config,r=nt(this.runtime.plugin||ct(this.context),t),[a,u]=this.checkUpdate(r,e),p=this.children.find(d=>d.config===s);this.config=r,p&&(this.context.emit("internal/before-update",p,t),p.config=r,a&&this.context.emit("internal/update",p,s)),u&&this.restart()}};N(xt,"MainScope");function zt(t){return t&&typeof t=="object"&&typeof t.apply=="function"}N(zt,"isApplicable");var $t=class extends Map{constructor(t,e){super(),this.root=t,$(this,x.current,t),t.scope=new xt(this,null,e),t.scope.runtime.isReactive=!0}_counter=0;get counter(){return++this._counter}resolve(t){return t&&(typeof t=="function"?t:t.apply)}get(t){return super.get(this.resolve(t))}has(t){return super.has(this.resolve(t))}set(t,e){return super.set(this.resolve(t),e)}delete(t){t=this.resolve(t);let e=this.get(t);return e?(super.delete(t),e.dispose()):!1}using(t,e){return this.plugin({using:t,apply:e,name:e.name})}plugin(t,e){if(typeof t!="function"&&!zt(t))throw new Error('invalid plugin, expect function or object with an "apply" method');if(e=nt(t,e),!e)return;let s=this[x.current],r=this.get(t);return r?(r.isForkable||this.root.emit("internal/warning",`duplicate plugin detected: ${t.name}`),r.fork(s,e)):(r=new xt(this,t,e),r.fork(s,e))}dispose(t){return this.delete(t)}};N($t,"Registry");B($t,"methods",["using","plugin","dispose"]);var It=class{constructor(t){let e=nt(ct(this),t),s=N(r=>{if(r){s(Object.getPrototypeOf(r));for(let a of Object.getOwnPropertySymbols(r))this[a]=new r[a](this,e)}},"attach");this.root=this,this.mapping=Object.create(null),s(this[It.internal])}[Symbol.for("nodejs.util.inspect.custom")](){return`Context <${this.runtime.name}>`}get events(){return this.lifecycle}get state(){return this.scope}extend(t={}){return Object.assign(Object.create(this),t)}isolate(t){let e=Object.create(this.mapping);for(let s of t)e[s]=Symbol(s);return this.extend({mapping:e})}},x=It;N(x,"Context");B(x,"config",Symbol("config"));B(x,"events",Symbol("events"));B(x,"static",Symbol("static"));B(x,"filter",Symbol("filter"));B(x,"source",Symbol("source"));B(x,"current",Symbol("current"));B(x,"internal",Symbol("internal"));B(x,"immediate",Symbol("immediate"));(t=>{function e(a,u){for(let p of u.methods||[])$(t.prototype,p,function(...d){return this[a][p](...d)});for(let p of u.properties||[])Object.defineProperty(t.prototype,p,{configurable:!0,get(){return this[a][p]},set(d){this[a][p]=d}})}t.mixin=e,N(e,"mixin");function s(a,u={}){let p=typeof a=="symbol"?a:Symbol(a);if(Object.defineProperty(this.prototype,a,{configurable:!0,get(){let d=this.mapping[a]||p,S=this.root[d];if(S)return $(S,t.current,this),S},set(d){let S=this.mapping[a]||p,f=this.root[S];if(f===d)return;let y=Object.create(null);if(y[t.filter]=n=>this.mapping[a]===n.mapping[a],d&&f&&typeof a=="string")throw new Error(`service ${a} has been registered`);typeof a=="string"&&this.emit(y,"internal/before-service",a,d),this.root[S]=d,d&&typeof d=="object"&&$(d,t.source,this),typeof a=="string"&&this.emit(y,"internal/service",a,f)}}),St(u)){let d=r(this.prototype);d[p]=u}e(a,u)}t.service=s,N(s,"service");function r(a){if(Object.prototype.hasOwnProperty.call(a,t.internal))return a[t.internal];let u=r(Object.getPrototypeOf(a));return a[t.internal]=Object.create(u)}N(r,"ensureInternal")})(x||(x={}));x.prototype[x.internal]=Object.create(null);x.service("registry",$t);x.service("lifecycle",vt);x.mixin("state",{properties:["config","runtime"],methods:["collect","accept","decline"]});var ie=class{constructor(t,e,s){this.ctx=t,ct(t.root).service(e),$(this,x.current,t),s&&(this[x.immediate]=e),t.on("ready",async()=>{await Promise.resolve(),await this.start(),t[e]=this}),t.on("dispose",async()=>{t[e]=null,await this.stop()})}start(){}stop(){}get caller(){return this[x.current]}};N(ie,"Service");var ce=Object.defineProperty,ae=Object.getOwnPropertyNames,C=(t,e)=>ce(t,"name",{value:e,configurable:!0}),fe=(t,e)=>function(){return e||(0,t[ae(t)[0]])((e={exports:{}}).exports,e),e.exports},ue=fe({"packages/schemastery/packages/core/src/index.ts"(t,e){var s=Symbol.for("schemastery");globalThis.__schemastery_index__??=0;var r=C(function(n){let i=C(function(o){return r.resolve(o,i)[0]},"schema");if(n.refs){let o=G(n.refs,l=>new r(l)),c=C(l=>o[l],"getRef");for(let l in o){let g=o[l];g.sKey=c(g.sKey),g.inner=c(g.inner),g.list=g.list&&g.list.map(c),g.dict=g.dict&&G(g.dict,c)}return o[n.uid]}return Object.assign(i,n),Object.defineProperty(i,"uid",{value:globalThis.__schemastery_index__++}),Object.setPrototypeOf(i,r.prototype),i.meta||={},i.toString=i.toString.bind(i),i},"Schema");r.prototype=Object.create(Function.prototype),r.prototype[s]=!0;var a;r.prototype.toJSON=C(function(){if(a)return a[this.uid]??=JSON.parse(JSON.stringify({...this})),this.uid;a={[this.uid]:{...this}},a[this.uid]=JSON.parse(JSON.stringify({...this}));let i={uid:this.uid,refs:a};return a=void 0,i},"toJSON"),r.prototype.set=C(function(i,o){return this.dict[i]=o,this},"set"),r.prototype.push=C(function(i){return this.list.push(i),this},"push");for(let n of["required","hidden"])Object.assign(r.prototype,{[n](i=!0){let o=r(this);return o.meta={...o.meta,[n]:i},o}});r.prototype.pattern=C(function(i){let o=r(this),c=rt(i,["source","flags"]);return o.meta={...o.meta,pattern:c},o},"pattern"),r.prototype.simplify=C(function(i){if(J(i,this.meta.default))return null;if(this.type==="object"||this.type==="dict"){let o={};for(let c in i){let g=(this.type==="object"?this.dict[c]:this.inner)?.simplify(i[c]);A(g)||(o[c]=g)}return o}else if(this.type==="array"||this.type==="tuple"){let o=[];for(let c of i){let l=this.type==="array"?this.inner:this.list[c],g=l?l.simplify(i[c]):i[c];o.push(g)}return o}else if(this.type==="intersect"){let o={};for(let c of this.list)Object.assign(o,c.simplify(i));return o}else if(this.type==="union")for(let o of this.list)try{return r.resolve(i,o),o.simplify(i)}catch{}return i},"simplify"),r.prototype.toString=C(function(i){return f[this.type]?.(this,i)??`Schema<${this.type}>`},"toString");for(let n of["default","role","link","comment","description","max","min","step"])Object.assign(r.prototype,{[n](i){let o=r(this);return o.meta={...o.meta,[n]:i},o}});var u={};r.extend=C(function(i,o){u[i]=o},"extend"),r.resolve=C(function(i,o,c){if(!o)return[i];if(A(i)){if(o.meta.required)throw new TypeError("missing required value");let g=o.meta.default;if(A(g))return[i];i=et(g)}let l=u[o.type];if(l)return l(i,o,c);throw new TypeError(`unsupported type "${o.type}"`)},"resolve"),r.from=C(function(i){if(A(i))return r.any();if(["string","number","boolean"].includes(typeof i))return r.const(i).required();if(i[s])return i;if(typeof i=="function")switch(i){case String:return r.string().required();case Number:return r.number().required();case Boolean:return r.boolean().required();case Function:return r.function().required();default:return r.is(i).required()}else throw new TypeError(`cannot infer schema from ${i}`)},"from"),r.natural=C(function(){return r.number().step(1).min(0)},"natural"),r.percent=C(function(){return r.number().step(.01).min(0).max(1).role("slider")},"percent"),r.date=C(function(){return r.union([r.is(Date),r.transform(r.string().role("datetime"),i=>{let o=new Date(i);if(isNaN(+o))throw new TypeError(`invalid date "${i}"`);return o},!0)])},"date"),r.extend("any",n=>[n]),r.extend("never",n=>{throw new TypeError(`expected nullable but got ${n}`)}),r.extend("const",(n,{value:i})=>{if(n===i)return[i];throw new TypeError(`expected ${i} but got ${n}`)});function p(n,i,o){let{max:c=1/0,min:l=-1/0}=i;if(n>c)throw new TypeError(`expected ${o} <= ${c} but got ${n}`);if(n<l)throw new TypeError(`expected ${o} >= ${l} but got ${n}`)}C(p,"checkWithinRange"),r.extend("string",(n,{meta:i})=>{if(typeof n!="string")throw new TypeError(`expected string but got ${n}`);if(i.pattern){let o=new RegExp(i.pattern.source,i.pattern.flags);if(!o.test(n))throw new TypeError(`expect string to match regexp ${o}`)}return p(n.length,i,"string length"),[n]}),r.extend("number",(n,{meta:i})=>{if(typeof n!="number")throw new TypeError(`expected number but got ${n}`);p(n,i,"number");let{step:o}=i;if(o){let c=Math.abs(n-(i.min??0))%o;if(c>=Number.EPSILON&&c<o-Number.EPSILON)throw new TypeError(`expected number multiple of ${o} but got ${n}`)}return[n]}),r.extend("boolean",n=>{if(typeof n=="boolean")return[n];throw new TypeError(`expected boolean but got ${n}`)}),r.extend("bitset",(n,{bits:i})=>{if(typeof n=="number")return[n];if(!Array.isArray(n))throw new TypeError(`expected array but got ${n}`);let o=0;for(let c of n){if(typeof c!="string")throw new TypeError(`expected string but got ${c}`);if(!(c in i))throw new TypeError(`unknown value ${c}`);o|=i[c]}return[o,o]}),r.extend("function",n=>{if(typeof n=="function")return[n];throw new TypeError(`expected function but got ${n}`)}),r.extend("is",(n,{callback:i})=>{if(n instanceof i)return[n];throw new TypeError(`expected ${i.name} but got ${n}`)});function d(n,i,o){let[c,l]=r.resolve(n[i],o);return A(l)||(n[i]=l),c}C(d,"property"),r.extend("array",(n,{inner:i,meta:o})=>{if(!Array.isArray(n))throw new TypeError(`expected array but got ${n}`);return p(n.length,o,"array length"),[n.map((c,l)=>d(n,l,i))]}),r.extend("dict",(n,{inner:i,sKey:o},c)=>{if(!Y(n))throw new TypeError(`expected object but got ${n}`);let l={};for(let g in n){let k;try{k=r.resolve(g,o)[0]}catch(M){if(c)continue;throw M}l[k]=d(n,g,i),n[k]=n[g],g!==k&&delete n[g]}return[l]}),r.extend("tuple",(n,{list:i},o)=>{if(!Array.isArray(n))throw new TypeError(`expected array but got ${n}`);let c=i.map((l,g)=>d(n,g,l));return o?[c]:(c.push(...n.slice(i.length)),[c])});function S(n,i){for(let o in i)o in n||(n[o]=i[o])}C(S,"merge"),r.extend("object",(n,{dict:i},o)=>{if(!Y(n))throw new TypeError(`expected object but got ${n}`);let c={};for(let l in i){let g=d(n,l,i[l]);(!A(g)||l in n)&&(c[l]=g)}return o||S(c,n),[c]}),r.extend("union",(n,{list:i,toString:o})=>{let c=[];for(let l of i)try{return r.resolve(n,l)}catch{}throw new TypeError(`expected ${o()} but got ${JSON.stringify(n)}`)}),r.extend("intersect",(n,{list:i,toString:o},c)=>{let l;for(let g of i){let k=r.resolve(n,g,!0)[0];if(!A(k))if(A(l))l=k;else{if(typeof l!=typeof k)throw new TypeError(`expected ${o()} but got ${JSON.stringify(n)}`);if(typeof k=="object")l={...l,...k};else if(l!==k)throw new TypeError(`expected ${o()} but got ${JSON.stringify(n)}`)}}return!c&&Y(n)&&S(l,n),[l]}),r.extend("transform",(n,{inner:i,callback:o,preserve:c})=>{let[l,g=n]=r.resolve(n,i,!0);if(Y(n)){let k={};for(let M in l)M in n&&(k[M]=n[M],delete n[M]);return Object.assign(n,o(k)),[o(l)]}else return c?[o(l)]:[o(l),o(g)]});var f={};function y(n,i,o){f[n]=o,Object.assign(r,{[n](...c){let l=new r({type:n});return i.forEach((g,k)=>{switch(g){case"sKey":l.sKey=c[k]??r.string();break;case"inner":l.inner=r.from(c[k]);break;case"list":l.list=c[k].map(r.from);break;case"dict":l.dict=G(c[k],r.from);break;case"bits":{l.bits={};for(let M in c[k])typeof c[k][M]=="number"&&(l.bits[M]=c[k][M]);break}default:l[g]=c[k]}}),n==="object"||n==="dict"?l.meta.default={}:n==="array"||n==="tuple"?l.meta.default=[]:n==="bitset"&&(l.meta.default=0),l}})}C(y,"defineMethod"),y("is",["callback"],({callback:n})=>n.name),y("any",[],()=>"any"),y("never",[],()=>"never"),y("const",["value"],({value:n})=>typeof n=="string"?JSON.stringify(n):n),y("string",[],()=>"string"),y("number",[],()=>"number"),y("boolean",[],()=>"boolean"),y("bitset",["bits"],()=>"bitset"),y("function",[],()=>"function"),y("array",["inner"],({inner:n})=>`${n.toString(!0)}[]`),y("dict",["inner","sKey"],({inner:n,sKey:i})=>`{ [key: ${i.toString()}]: ${n.toString()} }`),y("tuple",["list"],({list:n})=>`[${n.map(i=>i.toString()).join(", ")}]`),y("object",["dict"],({dict:n})=>Object.keys(n).length===0?"{}":`{ ${Object.entries(n).map(([i,o])=>`${i}${o.meta.required?"":"?"}: ${o.toString()}`).join(", ")} }`),y("union",["list"],({list:n},i)=>{let o=n.map(({toString:c})=>c()).join(" | ");return i?`(${o})`:o}),y("intersect",["list"],({list:n})=>`${n.map(i=>i.toString(!0)).join(" & ")}`),y("transform",["inner","callback","preserve"],({inner:n},i)=>n.toString(i)),e.exports=r}}),I=ue();import Tt from"https://registry.koishi.chat/modules/reggol/index.js";import pe from"https://registry.koishi.chat/modules/mime-db/index.js";import Ft from"https://registry.koishi.chat/modules/axios/index.js";var le=Object.defineProperty,at=(t,e)=>le(t,"name",{value:e,configurable:!0}),W=class{constructor(t,e){return W.create(e.request)}extend(t){return W.create({...this.config,...t,headers:{...this.config.headers,...t.headers}})}get(t,e){return this("GET",t,e)}delete(t,e){return this("DELETE",t,e)}post(t,e,s){return this("POST",t,{...s,data:e})}put(t,e,s){return this("PUT",t,{...s,data:e})}patch(t,e,s){return this("PATCH",t,{...s,data:e})}async head(t,e){return(await this.axios(t,{...e,method:"HEAD"})).headers}ws(t,e){return new WebSocket(t)}prepare(){return rt(this.config,["timeout","headers"])}async file(t){let e=/^data:([\w/-]+);base64,(.*)$/.exec(t);if(e){let[,d,S]=e,f=pe[d]?.extensions?.[0],y="file"+(f?"."+f:"");return{mime:d,filename:y,data:gt(S)}}let[s,r]=new URL(t).pathname.match(/.+\/([^/]*)/),{headers:a,data:u}=await this.axios(t,{method:"GET",responseType:"arraybuffer"});return{mime:a["content-type"],filename:r,data:u}}};at(W,"Quester");(t=>{t.isAxiosError=Ft.isAxiosError;function e(s={}){let r=ot(s.endpoint||""),a=at(async(p={})=>{let d=u.prepare();return Ft({...d,...p,url:r+p.url,headers:{...d.headers,...p.headers}})},"request"),u=at(async(p,d,S)=>(await a({url:d,...S,method:p})).data,"http");Object.setPrototypeOf(u,this.prototype);for(let p of["extend","get","delete","post","put","patch","head","ws"])u[p]=this.prototype[p].bind(u);return u.config=s,u.axios=(...p)=>typeof p[0]=="string"?a({url:p[0],...p[1]}):a(p[0]),u}t.create=e,at(e,"create")})(W||(W={}));x.service("http",W);var _t=W;var he=Object.defineProperty,de=Object.getOwnPropertyNames,P=(t,e)=>he(t,"name",{value:e,configurable:!0}),ye=(t,e)=>function(){return e||(0,t[de(t)[0]])((e={exports:{}}).exports,e),e.exports},me=ye({"satori/packages/element/src/index.ts"(t,e){var s=Symbol.for("satori.element");function r(f){return f&&typeof f=="object"&&f[s]}P(r,"isElement");function a(f){if(typeof f=="string"||typeof f=="number"||typeof f=="boolean"){if(f=""+f,f)return d("text",{content:f})}else{if(r(f))return f;if(!A(f))throw new TypeError(`Invalid content: ${f}`)}}P(a,"toElement");function u(f){return Array.isArray(f)?f.map(a).filter(y=>y):[a(f)].filter(y=>y)}P(u,"toElementArray");var p=class{get data(){return this.attrs}toString(f=!1){if(this.type==="text")return f?this.attrs.content:d.escape(this.attrs.content);let y=this.children.map(i=>i.toString(f)).join("");if(f)return y;let n=Object.entries(this.attrs).map(([i,o])=>A(o)?"":(i=Nt(i),o===!0?` ${i}`:o===!1?` no-${i}`:` ${i}="${d.escape(""+o,!0)}"`)).join("");return this.children.length?`<${this.type}${n}>${y}</${this.type}>`:`<${this.type}${n}/>`}};P(p,"ElementConstructor"),$(p,"name","Element"),$(p.prototype,s,!0);function d(f,...y){let n=Object.create(p.prototype),i={},o=[];if(y[0]&&typeof y[0]=="object"&&!r(y[0])&&!Array.isArray(y[0])){let c=y.shift();for(let[l,g]of Object.entries(c))A(g)||(l==="children"?y.push(...yt(g)):i[l]=g)}for(let c of y)o.push(...u(c));return Object.assign(n,{type:f,attrs:i,children:o})}P(d,"Element");var S=new Function("expr","context",`
  try {
    with (context) {
      return eval(expr)
    }
  } catch {}
`);(f=>{f.jsx=f,f.jsxs=f,f.jsxDEV=f,f.Fragment="template";function y(w,h){return typeof w!="string"?u(w):f.parse(w,h)}f.normalize=y,P(y,"normalize");function n(w,h=!1){let b=w.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");return h?b.replace(/"/g,"&quot;"):b}f.escape=n,P(n,"escape");function i(w){return w.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#(\d+);/g,(h,b)=>b==="38"?h:String.fromCharCode(+b)).replace(/&#x([0-9a-f]+);/gi,(h,b)=>b==="26"?h:String.fromCharCode(parseInt(b,16))).replace(/&(amp|#38|#x26);/g,"&")}f.unescape=i,P(i,"unescape");function o(w,h={}){let b=H(w);return h.caret?h.type&&b[0]?.type!==h.type?void 0:b[0]:g(b,h.type||"*")[0]}f.from=o,P(o,"from");let c=/ *([ >+~]) */g;function l(w){return w.split(",").map(h=>{let b=[];h=h.trim();let _,E=" ";for(;_=c.exec(h);)b.push({type:h.slice(0,_.index),combinator:E}),E=_[1],h=h.slice(_.index+_[0].length);return b.push({type:h,combinator:E}),b})}f.parseSelector=l,P(l,"parseSelector");function g(w,h){if(typeof w=="string"&&(w=H(w)),typeof h=="string"&&(h=l(h)),!h.length)return;let b=[],_=[];for(let[E,D]of w.entries()){let R=[],O=[...h,...b];b=[];let T=!1;for(let m of O){let{type:j,combinator:L}=m[0];(j===D.type||j==="*")&&(m.length===1?T=!0:[" ",">"].includes(m[1].combinator)?R.push(m.slice(1)):m[1].combinator==="+"?b.push(m.slice(1)):h.push(m.slice(1))),L===" "&&R.push(m)}T&&_.push(w[E]),_.push(...g(D.children,R))}return _}f.select=g,P(g,"select");function k(w,h){if(w=w.trim(),!/^[\w.]+$/.test(w))return S(w,h)??"";let b=h;for(let _ of w.split("."))if(b=b[_],A(b))return"";return b??""}f.interpolate=k,P(k,"interpolate");let M=/<!--[\s\S]*?-->|<(\/?)([^!\s>/]*)([^>]*?)\s*(\/?)>/,Ut=/([^\s=]+)(?:="([^"]*)"|='([^']*)')?/g,Jt=/([^\s=]+)(?:="([^"]*)"|='([^']*)'|=\{([^}]+)\})?/g,Wt=/\{([^}]*)\}/;function H(w,h){let b=[];function _(m){m&&b.push(f("text",{content:m}))}P(_,"pushText");let E=h?Jt:Ut,D;for(;D=M.exec(w);){R(w.slice(0,D.index));let[m,j,L,ht,dt]=D;if(w=w.slice(D.index+m.length),m.startsWith("<!"))continue;let X={source:m,type:L||f.Fragment,close:j,empty:dt,attrs:{}},jt;for(;jt=E.exec(ht);){let[xe,tt,Ht,Pt=Ht,At]=jt;At?X.attrs[st(tt)]=k(At,h):A(Pt)?tt.startsWith("no-")?X.attrs[st(tt.slice(3))]=!1:X.attrs[st(tt)]=!0:X.attrs[st(tt)]=i(Pt)}b.push(X)}R(w);function R(m){if(m=m.replace(/^\s*\n\s*/,"").replace(/\s*\n\s*$/,""),h){let j;for(;j=Wt.exec(m);){let[L,ht]=j;_(i(m.slice(0,j.index))),m=m.slice(j.index+L.length);let dt=k(ht,h);b.push(...u(dt))}}_(i(m))}P(R,"parseContent");let O=[f(f.Fragment)];function T(m){for(;m>0;m--){let{children:j}=O.shift(),{source:L}=O[0].children.pop();O[0].children.push(f("text",{content:L})),O[0].children.push(...j)}}P(T,"rollback");for(let m of b)if(r(m))O[0].children.push(m);else if(m.close){let j=0;for(;j<O.length&&O[j].type!==m.type;)j++;if(j===O.length)O[0].children.push(f("text",{content:m.source}));else{T(j);let L=O.shift();delete L.source}}else{let j=f(m.type,m.attrs);O[0].children.push(j),m.empty||(j.source=m.source,O.unshift(j))}return T(O.length-1),O[0].children}f.parse=H,P(H,"parse");function lt(w,h,b){let _=typeof w=="string"?H(w):w,E=[];return _.forEach(D=>{let{type:R,attrs:O,children:T}=D,m=h[R]??h.default??!0;typeof m=="function"&&(m=m(O,T,b)),m===!0?E.push(f(R,O,lt(T,h,b))):m!==!1&&E.push(...y(m))}),typeof w=="string"?E.join(""):E}f.transform=lt,P(lt,"transform");async function pt(w,h,b){let _=typeof w=="string"?H(w):w,E=(await Promise.all(_.map(async D=>{let{type:R,attrs:O,children:T}=D,m=h[R]??h.default??!0;return typeof m=="function"&&(m=await m(O,T,b)),m===!0?[f(R,O,await pt(T,h,b))]:m!==!1?y(m):[]}))).flat(1);return typeof w=="string"?E.join(""):E}f.transformAsync=pt,P(pt,"transformAsync");function Q(w,...h){return(...b)=>{let _=f(w);return h.forEach((E,D)=>{A(b[D])||(_.attrs[E]=b[D])}),b[h.length]&&Object.assign(_.attrs,b[h.length]),_}}P(Q,"createFactory"),f.warn=P(()=>{},"warn");function Z(w){return(h,...b)=>{let _="base64://";return typeof b[0]=="string"&&(_=`data:${b.shift()};base64,`),K("Buffer",h)?h=_+h.toString("base64"):K("ArrayBuffer",h)&&(h=_+mt(h)),h.startsWith("base64://")&&(0,f.warn)('protocol "base64:" is deprecated and will be removed in the future, please use "data:" instead'),f(w,{...b[0],url:h})}}P(Z,"createAssetFactory"),f.text=Q("text","content"),f.at=Q("at","id"),f.sharp=Q("sharp","id"),f.quote=Q("quote","id"),f.image=Z("image"),f.video=Z("video"),f.audio=Z("audio"),f.file=Z("file")})(d||(d={})),e.exports=d}}),q=me();import be from"https://registry.koishi.chat/modules/reggol/index.js";var Mt=Object.defineProperty,ge=(t,e,s)=>e in t?Mt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,F=(t,e)=>Mt(t,"name",{value:e,configurable:!0}),ut=(t,e,s)=>(ge(t,typeof e!="symbol"?e+"":e,s),s),Ot=class{constructor(t){this.app=t,$(this,U.current,t)}counter=0;transformers=Object.create(null);get caller(){return this[U.current]}component(t,e,s={}){let r=F(async(a,u,p)=>{if(s.session&&p.type==="send")throw new Error("interactive components is not available outside sessions");let d=await e(a,u,p);return p.transform(q.normalize(d))},"render");return this.transformers[t]=r,this.caller.collect("component",()=>{let a=this.transformers[t]===r;return a&&delete this.transformers[t],a})}};F(Ot,"Internal");ut(Ot,"methods",["component"]);var Bt=class{id;bot;app;constructor(t,e){Object.assign(this,e),this.selfId=t.selfId,this.platform=t.platform,$(this,"bot",t),$(this,"app",t.ctx.root),$(this,"id",++t.ctx.internal.counter),this.initialize()}initialize(){}get uid(){return`${this.platform}:${this.userId}`}get gid(){return`${this.platform}:${this.guildId}`}get cid(){return`${this.platform}:${this.channelId}`}get fid(){return`${this.platform}:${this.channelId}:${this.userId}`}get sid(){return`${this.platform}:${this.selfId}`}get content(){return this.elements.join("")}set content(t){this.elements=q.parse(t)}async transform(t){return await q.transformAsync(t,this.app.internal.transformers,this)}toJSON(){return Object.fromEntries(Object.entries(this).filter(([t])=>!t.startsWith("_")&&!t.startsWith("$")))}};F(Bt,"Session");var Lt=class{constructor(t,e){this.ctx=t,this.config=e,e.platform&&(this.platform=e.platform),e.selfId&&(this.selfId=e.selfId),this.context=t,t.bots.push(this),this.context.emit("bot-added",this),t.on("ready",()=>this.start()),t.on("dispose",()=>{z(t.bots,this),this.context.emit("bot-removed",this),this.stop()})}isBot=!0;hidden=!1;platform;selfId;internal;adapter;error;context;_status="offline";get status(){return this._status}set status(t){this._status=t,this.ctx.bots.includes(this)&&this.context.emit("bot-status-updated",this)}online(){this.status="online",this.error=null}offline(t){this.status="offline",this.error=t}async start(){if(!["connect","reconnect","online"].includes(this.status)){this.status="connect";try{await this.context.parallel("bot-connect",this),await this.adapter.start(this)}catch(t){this.offline(t)}}}async stop(){if(!["disconnect","offline"].includes(this.status)){this.status="disconnect";try{await this.context.parallel("bot-disconnect",this),await this.adapter.stop(this)}catch(t){this.context.emit("internal/warning",t),this.offline()}}}get sid(){return`${this.platform}:${this.selfId}`}session(t){return new Bt(this,t)}dispatch(t){if(!this.ctx.lifecycle.isActive)return;let e=[t.type];t.subtype&&(e.unshift(e[0]+"/"+t.subtype),t.subsubtype&&e.unshift(e[0]+"/"+t.subsubtype));for(let s of e)this.context.emit(t,s,t)}};F(Lt,"Bot");ut(Lt,"reusable",!0);var it=new be("adapter"),ft=class{async start(t){}async stop(t){}};F(ft,"Adapter");ut(ft,"schema",!1);(t=>{class e extends t{constructor(u,p){super(),this.ctx=u,this.bot=p,p.adapter=this}static reusable=!0}F(e,"Client"),t.Client=e;class s extends t{bots=[];fork(u,p){p.adapter=this,this.bots.push(p),u.on("dispose",()=>{z(this.bots,p)})}}F(s,"Server"),t.Server=s;class r extends t.Client{static reusable=!0;static Config=I.object({retryTimes:I.natural().description("初次连接时的最大重试次数。").default(6),retryInterval:I.natural().role("ms").description("初次连接时的重试时间间隔。").default(5*V.second),retryLazy:I.natural().role("ms").description("连接关闭后的重试时间间隔。").default(V.minute)}).description("连接设置");async start(u){let p=0,{retryTimes:d,retryInterval:S,retryLazy:f}=u.config,y=F(async(n=!1)=>{it.debug("websocket client opening");let i=await this.prepare(u),o=i.url.replace(/\?.+/,"");i.onerror=c=>it.debug(c),i.onclose=({code:c,reason:l})=>{if(u.socket=null,it.debug(`websocket closed with ${c}`),u.status==="disconnect")return u.status="offline";let g=l.toString()||`failed to connect to ${o}, code: ${c}`,k=S;if(p>=d){if(n)return u.error=new Error(g),u.status="offline";k=f}p++,u.status="reconnect",it.warn(`${g}, will retry in ${V.format(k)}...`),setTimeout(()=>{u.status==="reconnect"&&y()},k)},i.onopen=()=>{p=0,u.socket=i,it.info("connect to server: %c",o),this.accept(u)}},"reconnect");y(!0)}async stop(u){u.socket?.close()}}F(r,"WsClient"),t.WsClient=r})(ft||(ft={}));var qt=class extends Error{constructor(t,e=""){super(e),this.errors=t}};F(qt,"AggregateError");var we=class{constructor(t,e,s,r={}){this.bot=t,this.channelId=e,this.guildId=s,this.options=r,this.session=t.session({type:"send",author:t,channelId:e,guildId:s,subtype:s?"group":"private"}),$(this.session,t.platform,Object.create(t.internal))}errors=[];results=[];session;async render(t,e){for(let s of t)await this.visit(s);e&&await this.flush()}async send(t){if(this.session.elements=q.normalize(t),await this.session.app.serial(this.session,"before-send",this.session,this.options))return;let e=this.options.session??this.session;if(await this.render(await e.transform(this.session.elements)),await this.flush(),this.errors.length)throw new qt(this.errors);return this.results.map(s=>s.messageId)}};F(we,"Messenger");q.warn=new Tt("element").warn;$(_t,"Config",I.object({timeout:I.natural().role("ms").description("等待连接建立的最长时间。")}).description("请求设置"));_t.createConfig=F(function(e){return I.object({endpoint:I.string().role("link").description("要连接的服务器地址。").default(typeof e=="string"?e:null).required(typeof e=="boolean"?e:!1),headers:I.dict(String).role("table").description("要附加的额外请求头。"),...this.Config.dict}).description("请求设置")},"createConfig");var U=class extends x{constructor(t){super(t),this.on("internal/warning",(e,...s)=>{this.logger("app").warn(e,...s)})}logger(t){return new Tt(t)}};F(U,"Context");ut(U,"session",Symbol("session"));(t=>{t.Config=I.intersect([I.object({})])})(U||(U={}));U.service("internal",Ot);U.service("bots",class{constructor(t){let e=[];return new Proxy(e,{get(s,r){return r in s||typeof r=="symbol"?s[r]:e.find(a=>a.sid===r)},deleteProperty(s,r){if(r in s||typeof r=="symbol")return delete s[r];let a=s.findIndex(u=>u.sid===r);return a<0||s.splice(a,1),!0}})}});export{ft as Adapter,Lt as Bot,U as Context,q as Element,Ot as Internal,Tt as Logger,we as Messenger,we as Modulator,_t as Quester,I as Schema,Bt as Session,q as h,q as segment,I as z};
