var I=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var Q=Object.getOwnPropertyNames;var W=Object.prototype.hasOwnProperty;var $=(t,e)=>()=>(t&&(e=t(t=0)),e);var b=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var T=(t,e,a,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Q(e))!W.call(t,i)&&i!==a&&I(t,i,{get:()=>e[i],enumerable:!(r=R(e,i))||r.enumerable});return t},E=(t,e,a)=>(T(t,e,"default"),a&&T(a,e,"default"));var O=t=>T(I({},"__esModule",{value:!0}),t);var f={};import*as re from"https://registry.koishi.chat/modules/koishi/index.js";var x=$(()=>{E(f,re)});var C=b(c=>{"use strict";Object.defineProperty(c,"__esModule",{value:!0});c.stripDataPrefix=c.NetworkError=c.download=c.arrayBufferToBase64=void 0;var F=(x(),O(f));function q(t){{let e="";for(let r=0;r<t.byteLength;r+=8192)e+=String.fromCharCode.apply(null,t.slice(r,r+8192));return btoa(e)}}c.arrayBufferToBase64=q;var G=10485760,P=["image/jpeg","image/png"];async function H(t,e,a={}){if(e.startsWith("data:")){let[,r,i]=e.match(/^data:(image\/\w+);base64,(.*)$/);if(!P.includes(r))throw new p(".unsupported-file-type");let n=atob(i),d=new Uint8Array(n.length);for(let l=0;l<n.length;l++)d[l]=n.charCodeAt(l);return{buffer:d,base64:i,dataUrl:e}}else{let r=await t.http.head(e,{headers:a});if(+r["content-length"]>G)throw new p(".file-too-large");let i=r["content-type"];if(!P.includes(i))throw new p(".unsupported-file-type");let n=await t.http.get(e,{responseType:"arraybuffer",headers:a}),d=q(n);return{buffer:n,base64:d,dataUrl:`data:${i};base64,${d}`}}}c.download=H;var p=class extends Error{constructor(e,a={}){super(e),this.params=a}};c.NetworkError=p;p.catch=t=>e=>{if(F.Quester.isAxiosError(e)){let a=e.response?.status;for(let r in t)if(a===+r)throw new p(t[r])}throw e};function K(t){return t.replace(/^data:image\/[\w-]+;base64,/,"")}c.stripDataPrefix=K});var N=b(y=>{"use strict";Object.defineProperty(y,"__esModule",{value:!0});y.Config=void 0;var u=(x(),O(f));y.Config=u.Schema.intersect([u.Schema.object({endpoint:u.Schema.string().description("API 服务器地址。例如 http://127.0.0.1:7860").default("http://127.0.0.1:7860"),headers:u.Schema.dict(String).description("要附加的额外请求头。如无必要，此项不填写。")}).description("接入设置"),u.Schema.object({upscalers:u.Schema.array(String).description("允许使用的超分辨率模型，默认使用第一个。").default(["SwinIR 4x","ScuNET","ScuNET PSNR","ESRGAN_4x","LDSR","Nearest","Lanczos","None"])}).description("模型设置"),u.Schema.object({maxRetryCount:u.Schema.natural().description("连接失败时最大的重试次数。").default(3),requestTimeout:u.Schema.number().role("time").description("当请求超过这个时间时会中止并提示超时。").default(u.Time.minute),recallTimeout:u.Schema.number().role("time").description("图片发送后自动撤回的时间 (设置为 0 以禁用此功能)。").default(0),maxConcurrency:u.Schema.number().description("单个频道下的最大并发数量 (设置为 0 以禁用此功能)。").default(0)}).description("高级设置")])});var D=b((ie,V)=>{V.exports={commands:{extra:{description:"使用 SD-WebUI 对输入的图像进行超分辨率处理。",usage:`对输入的图像进行超分辨率处理
此插件基于 https://github.com/koishijs/novelai-bot 修改完成, 快去给原项目点个 star 吧！`,options:{resize:"放大倍数 (1~4) 默认为 2",upscaler:"通过名称选择模型（没做完",upscalerIndex:"通过序号选择模型（没做完"},example:"extra [图片]; extra -r 1.5 [图片]。",messages:{"expect-image":"请输入图片。","concurrent-jobs@random":["等会再约稿吧，我已经忙不过来了……","是数位板没电了，才…才不是我不想画呢！","那你得先教我画画（理直气壮"],"waiting@random":["少女绘画中……","在画了在画了","你就在此地不要走动，等我给你画一幅"],pending:"在画了在画了，不过前面还有 {0} 个稿……","file-too-large":"文件体积过大。","unsupported-file-type":"不支持的文件格式。","download-error":"图片解析失败。","unknown-error":"发生未知错误。","response-error":"发生未知错误 ({0})。","empty-response":"服务器返回了空白图片，请稍后重试。","request-failed":"请求失败 ({0})，请稍后重试。","request-timeout":"请求超时。"}}}}});var ee=b(s=>{var X=s&&s.__createBinding||(Object.create?function(t,e,a,r){r===void 0&&(r=a);var i=Object.getOwnPropertyDescriptor(e,a);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[a]}}),Object.defineProperty(t,r,i)}:function(t,e,a,r){r===void 0&&(r=a),t[r]=e[a]}),Y=s&&s.__exportStar||function(t,e){for(var a in t)a!=="default"&&!Object.prototype.hasOwnProperty.call(e,a)&&X(e,t,a)};Object.defineProperty(s,"__esModule",{value:!0});s.apply=s.name=s.reactive=void 0;var m=(x(),O(f)),j=C();Y(N(),s);s.reactive=!0;s.name="extra";var A=new m.Logger("extra");function Z(t,e){if(m.Quester.isAxiosError(e)){if(e.response?.status===402)return t.text(".unauthorized");if(e.response?.status)return t.text(".response-error",[e.response.status]);if(e.code==="ETIMEDOUT")return t.text(".request-timeout");if(e.code)return t.text(".request-failed",[e.code])}return A.error(e),t.text(".unknown-error")}function J(t,e){t.i18n.define("zh",D());let a=Object.create(null),r=new Set,i=t.command("extra <prompts:text>").alias("ext").userFields(["authority"]).shortcut("放大",{fuzzy:!0}).option("resize","-r <resize:number>").option("upscaler","-s <upscaler:string>").option("upscalerIndex","-i <upscalerIndex:number>").action(async({session:n,options:d},l)=>{var v;if(!l?.trim())return n.execute("help extra");let w,S;l=m.segment.transform(l,{image(o){return w=o.url,""}});let h={resize:2,upscalerIndex:0,upscaler:void 0};if(Object.assign(h,{resize:d.resize??2,upscalerIndex:d.upscalerIndex??0}),w)try{S=await(0,j.download)(t,w)}catch(o){return o instanceof j.NetworkError?n.text(o.message,o.params):(A.error(o),n.text(".download-error"))}let g=Math.random().toString(36).slice(2);if(e.maxConcurrency){let o=a[v=n.cid]||(a[v]=new Set);if(o.size>=e.maxConcurrency)return n.text(".concurrent-jobs");o.add(g)}n.send(r.size?n.text(".pending",[r.size]):n.text(".waiting")),r.add(g);let z=()=>{a[n.cid]?.delete(g),r.delete(g)},B=(()=>({image:S&&S.dataUrl,upscaling_resize:h.resize,upscaler_1:h.upscaler??e.upscalers[h.upscalerIndex??0]}))(),M=()=>t.http.axios((0,m.trimSlash)(e.endpoint)+"/sdapi/v1/extra-single-image",{method:"POST",timeout:e.requestTimeout,headers:{...e.headers},data:B}).then(o=>(0,j.stripDataPrefix)(o.data.image)),_,U=0;for(;;)try{_=await M(),z();break}catch(o){if(m.Quester.isAxiosError(o)&&o.code&&o.code!=="ETIMEDOUT"&&++U<e.maxRetryCount)continue;return z(),Z(n,o)}if(!_.trim())return n.text(".empty-response");function k(){return m.segment.image("base64://"+_)}let L=await n.send(k());e.recallTimeout&&t.setTimeout(()=>{for(let o of L)n.bot.deleteMessage(n.channelId,o)},e.recallTimeout)})}s.apply=J});export default ee();
