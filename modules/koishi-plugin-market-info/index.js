var v=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var j=Object.getOwnPropertyNames;var $=Object.prototype.hasOwnProperty;var D=(t,e)=>()=>(t&&(e=t(t=0)),e);var y=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var g=(t,e,c,h)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of j(e))!$.call(t,n)&&n!==c&&v(t,n,{get:()=>e[n],enumerable:!(h=k(e,n))||h.enumerable});return t},b=(t,e,c)=>(g(t,e,"default"),c&&g(c,e,"default"));var q=t=>g(v({},"__esModule",{value:!0}),t);var f={};import*as _ from"https://registry.koishi.chat/modules/koishi/index.js";var I=D(()=>{b(f,_)});var S=y((z,C)=>{C.exports={commands:{market:{description:"插件市场信息",messages:{overview:"当前共有 {0} 个插件。"}}}}});var P=y(s=>{Object.defineProperty(s,"__esModule",{value:!0});s.apply=s.Config=s.Rule=s.name=void 0;var i=(I(),q(f)),M=new i.Logger("market");s.name="market-info";s.Rule=i.Schema.object({platform:i.Schema.string().description("平台名称。").required(),channelId:i.Schema.string().description("频道 ID。").required(),guildId:i.Schema.string().description("群组 ID。"),selfId:i.Schema.string().description("机器人 ID。")});s.Config=i.Schema.object({rules:i.Schema.array(s.Rule).description("推送规则。"),interval:i.Schema.number().default(i.Time.minute*30).description("轮询间隔 (毫秒)。"),showHidden:i.Schema.boolean().default(!1).description("是否显示隐藏的插件。"),showDeletion:i.Schema.boolean().default(!1).description("是否显示删除的插件。"),showPublisher:i.Schema.boolean().default(!1).description("是否显示插件发布者。"),showDescription:i.Schema.boolean().default(!1).description("是否显示插件描述。")});function O(t,e){t.i18n.define("zh",S());let c=n=>{let o={};for(let l of n.objects)l.manifest.hidden&&!e.showHidden||(o[l.shortname]=l);return o},h=async()=>{let n=await t.http.get("https://registry.koishi.chat/market.json");return c(n)};t.on("ready",async()=>{let n=await h();t.command("market").action(async({session:o})=>o.text(".overview",[Object.keys(n).length])),t.setInterval(async()=>{let o=await h(),l=Object.keys({...n,...o}).map(r=>{let d=n[r]?.version,a=o[r]?.version;if(d!==a){if(!d){let u=`新增：${r}`;if(e.showPublisher&&(u+=` (@${o[r].publisher.username})`),e.showDescription){let{description:p}=o[r].manifest;u+=`
  ${p.zh||p.en}`}return u}if(a)return`更新：${r} (${d} → ${a})`;if(e.showDeletion)return`删除：${r}`}}).filter(Boolean).sort();if(n=o,!l.length)return;let w=["[插件市场更新]",...l].join(`
`);M.info(w);for(let{channelId:r,platform:d,selfId:a,guildId:u}of e.rules){if(!a){let m=await t.database.getChannel(d,r,["assignee","guildId"]);if(!m||!m.assignee)return;a=m.assignee,u=m.guildId}t.bots[`${d}:${a}`]?.sendMessage(r,w,u)}},e.interval)})}s.apply=O});export default P();
